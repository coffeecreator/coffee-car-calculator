<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Coffee‑Car Buchungs‑Wizard · Final</title>
<style>
  :root{ --mint:#8BC4B5; --mint-strong:#5DB6A1; --ink:#1A1F2B; --ink-soft:#3B4150; --bg:#FAFBFC; --card:#FFFFFF; --line:#E6E8EB; --muted:#6B7280; --accent:#0F766E; --radius:16px; --shadow:0 6px 24px rgba(0,0,0,.06);}
  *{box-sizing:border-box} body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink)}
  .wrap{max-width:1200px; margin:auto; padding:20px}
  .header{display:flex; justify-content:space-between; align-items:center; gap:14px; margin-bottom:12px}
  .logo svg{height:64px}
  .steps{display:flex; gap:8px; align-items:center}
  .dot{width:11px; height:11px; border-radius:50%; background:#d7e7e3; border:1px solid #cfe7df}
  .dot.active{background:var(--mint); border-color:var(--mint-strong)}
  h1{margin:0; font-size:clamp(20px,3.8vw,34px)}
  .grid2{display:grid; grid-template-columns:1fr; gap:18px}
  .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow)}
  .row{display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
  label{font-weight:700; margin:6px 0}
  input,select,button,textarea{width:100%; padding:12px; border-radius:12px; border:1px solid var(--line); background:#fff; color:var(--ink)}
  input:focus,select:focus,textarea:focus{outline:2px solid var(--mint); outline-offset:1px}
  .btn{cursor:pointer; font-weight:900; background:linear-gradient(90deg,var(--mint),var(--mint-strong)); border:none; color:#083B35}
  .btn-ghost{background:transparent; border:1px solid var(--line); color:var(--ink)}
  .toolbar{display:flex; gap:10px; justify-content:flex-end; margin-top:12px}
  .muted{color:var(--muted)}
  .hidden{display:none !important}
  .info{display:flex; gap:10px; align-items:flex-start; padding:10px; border:1px dashed var(--line); border-radius:12px; background:#F6FAF9; margin-top:8px}
  .ok{color:#0C3F37} .warn{color:#8B5E00}
  .gallery{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:12px}
  .ref-card{border:1px solid var(--line); border-radius:14px; background:#fff; padding:12px; display:flex; gap:12px; align-items:center}
  .ref-card img,.ref-card svg{width:120px; height:auto}
  .choice,.segment{cursor:pointer; transition:transform .05s ease}
  .choice.active,.segment.active{outline:2px solid var(--mint); border-radius:14px}
  .badge{display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; background:#EEF7F5; border:1px solid var(--line); color:#0C3F37; margin-right:6px; margin-bottom:6px}
  .pricebox{display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:999px; background:#F3F7F6; border:1px dashed var(--line); color:var(--accent); margin-top:10px}
  .addon{display:flex; justify-content:space-between; align-items:center; gap:12px}
</style>

<link rel="icon" type="image/svg+xml" href="favicon.svg"/>
<link rel="alternate icon" href="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20120%20120%22%20width%3D%2256%22%20aria-label%3D%22CC%20monogram%22%3E%0A%20%20%3Cdefs%3E%3ClinearGradient%20id%3D%22gc%22%20x1%3D%220%22%20x2%3D%221%22%3E%3Cstop%20offset%3D%220%22%20stop-color%3D%22%238BC4B5%22/%3E%3Cstop%20offset%3D%221%22%20stop-color%3D%22%235DB6A1%22/%3E%3C/linearGradient%3E%3C/defs%3E%0A%20%20%3Ccircle%20cx%3D%2260%22%20cy%3D%2260%22%20r%3D%2256%22%20fill%3D%22%23ffffff%22%20stroke%3D%22%23E6E8EB%22/%3E%0A%20%20%3Cpath%20d%3D%22M36%2060a24%2024%200%201%201%200%200%22%20fill%3D%22none%22%20stroke%3D%22url%28%23gc%29%22%20stroke-width%3D%2210%22%20stroke-linecap%3D%22round%22/%3E%0A%20%20%3Cpath%20d%3D%22M76%2060a24%2024%200%201%201%200%200%22%20fill%3D%22none%22%20stroke%3D%22%230F766E%22%20stroke-width%3D%2210%22%20stroke-linecap%3D%22round%22/%3E%0A%3C/svg%3E"/>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="logo"><img id="brandLogo" alt="Coffee‑Car Logo" src="data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20360%20100%22%20width%3D%22180%22%20aria-label%3D%22Coffee%E2%80%91Car%22%3E%0A%20%20%3Cdefs%3E%3ClinearGradient%20id%3D%22g%22%20x1%3D%220%22%20x2%3D%221%22%3E%3Cstop%20offset%3D%220%22%20stop-color%3D%22%238BC4B5%22/%3E%3Cstop%20offset%3D%221%22%20stop-color%3D%22%235DB6A1%22/%3E%3C/linearGradient%3E%3C/defs%3E%0A%20%20%3Cg%20fill%3D%22none%22%20stroke%3D%22url%28%23g%29%22%20stroke-width%3D%2210%22%20stroke-linecap%3D%22round%22%3E%0A%20%20%20%20%3Cpath%20d%3D%22M20%2C70%20C50%2C20%20110%2C20%20140%2C70%22/%3E%0A%20%20%20%20%3Cpath%20d%3D%22M80%2C70%20C110%2C20%20170%2C20%20200%2C70%22/%3E%0A%20%20%3C/g%3E%0A%20%20%3Ccircle%20cx%3D%2285%22%20cy%3D%2278%22%20r%3D%2210%22%20fill%3D%22%230F766E%22/%3E%0A%20%20%3Ccircle%20cx%3D%22205%22%20cy%3D%2278%22%20r%3D%2210%22%20fill%3D%22%230F766E%22/%3E%0A%20%20%3Ctext%20x%3D%22220%22%20y%3D%2245%22%20font-size%3D%2228%22%20font-family%3D%22Inter%2Csystem-ui%2CSegoe%20UI%2CRoboto%2CArial%22%20fill%3D%22%231A1F2B%22%20font-weight%3D%22800%22%3ECoffee%E2%80%91Car%3C/text%3E%0A%20%20%3Ctext%20x%3D%22220%22%20y%3D%2272%22%20font-size%3D%2214%22%20font-family%3D%22Inter%2Csystem-ui%2CSegoe%20UI%2CRoboto%2CArial%22%20fill%3D%22%233B4150%22%3EProfessional%20Coffee%20Catering%3C/text%3E%0A%3C/svg%3E" /><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 360 100" width="180" aria-label="Coffee‑Car">
  <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#8BC4B5"/><stop offset="1" stop-color="#5DB6A1"/></linearGradient></defs>
  <g fill="none" stroke="url(#g)" stroke-width="10" stroke-linecap="round">
    <path d="M20,70 C50,20 110,20 140,70"/>
    <path d="M80,70 C110,20 170,20 200,70"/>
  </g>
  <circle cx="85" cy="78" r="10" fill="#0F766E"/>
  <circle cx="205" cy="78" r="10" fill="#0F766E"/>
  <text x="220" y="45" font-size="28" font-family="Inter,system-ui,Segoe UI,Roboto,Arial" fill="#1A1F2B" font-weight="800">Coffee‑Car</text>
  <text x="220" y="72" font-size="14" font-family="Inter,system-ui,Segoe UI,Roboto,Arial" fill="#3B4150">Professional Coffee Catering</text>
</svg></div>
    
<div style="display:flex; gap:8px; align-items:center">
  <button class="btn-ghost" id="logoPrimaryBtn" title="Primärlogo">Primär</button>
  <button class="btn-ghost" id="logoMonoBtn" title="Monochrom">Mono</button>
  <button class="btn-ghost" id="logoCompactBtn" title="Kompakt">Kompakt</button>
</div>
<div class="steps"><div class="dot" id="s1"></div><div class="dot" id="s2"></div><div class="dot" id="s3"></div><div class="dot" id="s4"></div><div class="dot" id="s5"></div><div class="dot" id="s6"></div></div>
  </div>

  <div id="summary" class="muted" style="margin:6px 0 12px"></div>

  <div class="grid2">
    <!-- STEP 1 -->
    <div class="card" id="step1">
      <h2>1) Wann &amp; Wo findet das Event statt?</h2>
      <div class="row">
        <div><label>Datum (Start)</label><input id="date_start" type="date"/></div>
        <div><label>Datum (Ende)</label><input id="date_end" type="date" placeholder="optional"/></div>
        <div><label>Ort / PLZ</label><input id="location" maxlength="140" placeholder="z. B. 60313 Frankfurt"/></div>
      </div>
      <div class="toolbar"><button class="btn" id="checkAvail">Verfügbarkeit prüfen</button></div>
      <div class="info hidden" id="availInfo"></div>
    </div>

    <!-- STEP 2 -->
    <div class="card hidden" id="step2">
      <h2>2) Wer fragt an?</h2>
      <div class="gallery" id="segmentGrid">
        <div class="ref-card segment" data-value="Privat"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 220 140" width="320">
  <rect rx="16" ry="16" x="5" y="5" width="210" height="130" fill="#f4f7f6" stroke="#e6e8eb"/>
  <g transform="translate(60,25)">
    <ellipse cx="50" cy="18" rx="50" ry="16" fill="#d2e7e2"/>
    <ellipse cx="50" cy="18" rx="46" ry="12" fill="#ffffff"/>
    <rect x="4" y="18" width="92" height="52" rx="10" fill="#ffffff"/>
    <rect x="4" y="70" width="92" height="30" rx="10" fill="#e8f2ef"/>
    <path d="M12 40 C30 20, 70 20, 88 40 C70 60, 30 60, 12 40 Z" fill="#f2c9a6"/>
    <circle cx="95" cy="44" r="10" fill="none" stroke="#9acabc" stroke-width="6"/>
  </g>
</svg><div><h4>Privat</h4><p class="muted">Hochzeiten, Geburtstage, Familienfeiern</p></div></div>
        <div class="ref-card segment" data-value="Gewerblich"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 220 140" width="320">
  <defs><linearGradient id="a" x1="0" x2="1"><stop offset="0" stop-color="#c48a5a"/><stop offset="1" stop-color="#8b5b2e"/></linearGradient></defs>
  <rect rx="16" ry="16" x="5" y="5" width="210" height="130" fill="#f4f7f6" stroke="#e6e8eb"/>
  <g transform="translate(30,25)">
    <rect x="0" y="0" width="160" height="18" rx="9" fill="#1A1F2B"/>
    <rect x="10" y="28" width="60" height="8" rx="4" fill="#9aa3b2"/>
    <rect x="90" y="28" width="20" height="8" rx="4" fill="#9aa3b2"/>
    <path d="M78,18 v34" stroke="#1A1F2B" stroke-width="6" stroke-linecap="round"/>
    <rect x="62" y="52" width="32" height="22" rx="5" fill="#ddd"/>
    <rect x="58" y="76" width="40" height="22" rx="8" fill="url(#a)"/>
    <rect x="52" y="98" width="52" height="8" rx="4" fill="#6b4b2a"/>
  </g>
</svg><div><h4>Gewerblich</h4><p class="muted">Messen, Eröffnungen, Firmenfeiern</p></div></div>
        <div class="ref-card segment" data-value="Agenturen / Wiederverkäufer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 220 140" width="320">
  <defs><linearGradient id="a" x1="0" x2="1"><stop offset="0" stop-color="#c48a5a"/><stop offset="1" stop-color="#8b5b2e"/></linearGradient></defs>
  <rect rx="16" ry="16" x="5" y="5" width="210" height="130" fill="#f4f7f6" stroke="#e6e8eb"/>
  <g transform="translate(30,25)">
    <rect x="0" y="0" width="160" height="18" rx="9" fill="#1A1F2B"/>
    <rect x="10" y="28" width="60" height="8" rx="4" fill="#9aa3b2"/>
    <rect x="90" y="28" width="20" height="8" rx="4" fill="#9aa3b2"/>
    <path d="M78,18 v34" stroke="#1A1F2B" stroke-width="6" stroke-linecap="round"/>
    <rect x="62" y="52" width="32" height="22" rx="5" fill="#ddd"/>
    <rect x="58" y="76" width="40" height="22" rx="8" fill="url(#a)"/>
    <rect x="52" y="98" width="52" height="8" rx="4" fill="#6b4b2a"/>
  </g>
</svg><div><h4>Agenturen / Wiederverkäufer</h4><p class="muted">White-Label & Promotion</p></div></div>
        <div class="ref-card segment" data-value="Behörden / Öffentliche Einrichtungen"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 220 140" width="320">
  <rect rx="16" ry="16" x="5" y="5" width="210" height="130" fill="#f4f7f6" stroke="#e6e8eb"/>
  <g transform="translate(60,25)">
    <ellipse cx="50" cy="18" rx="50" ry="16" fill="#d2e7e2"/>
    <ellipse cx="50" cy="18" rx="46" ry="12" fill="#ffffff"/>
    <rect x="4" y="18" width="92" height="52" rx="10" fill="#ffffff"/>
    <rect x="4" y="70" width="92" height="30" rx="10" fill="#e8f2ef"/>
    <path d="M12 40 C30 20, 70 20, 88 40 C70 60, 30 60, 12 40 Z" fill="#f2c9a6"/>
    <circle cx="95" cy="44" r="10" fill="none" stroke="#9acabc" stroke-width="6"/>
  </g>
</svg><div><h4>Behörden / Öffentliche Einrichtungen</h4><p class="muted">Schulen, Ämter, Stadtverwaltung</p></div></div>
      </div>
      <div class="toolbar"><button class="btn-ghost" id="back2">Zurück</button><button class="btn" id="next2">Weiter</button></div>
    </div>

    <!-- STEP 3 -->
    <div class="card hidden" id="step3">
      <h2>3) Was ist Ihnen besonders wichtig?</h2>
      <div class="gallery" id="priorityGrid">
        <div class="ref-card choice" data-value="Preis &amp; Wirtschaftlichkeit">Preis &amp; Wirtschaftlichkeit</div>
        <div class="ref-card choice" data-value="Einfach &amp; Zuverlässig">Einfach &amp; Zuverlässig</div>
        <div class="ref-card choice" data-value="Qualität &amp; Auftritt">Qualität &amp; Auftritt</div>
        <div class="ref-card choice" data-value="Luxus &amp; Individualisierung">Luxus &amp; Individualisierung</div>
        <div class="ref-card choice" data-value="Nachhaltigkeit">Nachhaltigkeit</div>
        <div class="ref-card choice" data-value="Faire Löhne">Faire Löhne</div>
        <div class="ref-card choice" data-value="Große Auswahl an Milchalternativen">Große Auswahl an Milchalternativen</div>
        <div class="ref-card choice" data-value="Barista mit Latte‑Art‑Skill">Barista mit Latte‑Art‑Skill</div>
      </div>
      <div class="toolbar"><button class="btn-ghost" id="back3">Zurück</button><button class="btn" id="next3">Weiter</button></div>
    </div>

    <!-- STEP 4 -->
    <div class="card hidden" id="step4">
      <h2>4) Passende Referenzen</h2>
      <p class="muted">Aus über 3.000 Coffee‑Events empfehlen wir vergleichbare Setups.</p>
      <div class="row">
        <div><label>Kategorie</label><select id="refCategory"></select></div>
        <div><label>Unterkategorie</label><select id="refSub"></select></div>
      </div>
      <div id="refGrid" class="gallery" style="margin-top:12px"></div>
      <div class="toolbar"><button class="btn-ghost" id="back4">Zurück</button><button class="btn" id="next4">Weiter</button></div>
    </div>

    <!-- STEP 5 -->
    <div class="card hidden" id="step5">
      <h2>5) Preis &amp; Optionen</h2>
      <div class="row">
        <div><label>Gästezahl</label><input id="guests" type="number" min="1" value="80"/></div>
        <div><label>Ausschankbeginn</label><input id="start_time" type="time" value="09:00"/></div>
        <div><label>Ausschankende</label><input id="end_time" type="time" value="13:00"/></div>
        <div>
          <label>Becher / Tassen</label>
          <select id="cupType">
            <option>Einwegbecher (kompostierbar)</option>
            <option>Porzellantassen</option>
            <option>Kunde stellt Tassen</option>
            <option>Branding‑Becher</option>
          </select>
        </div>
      </div>
      <div class="gallery" style="margin-top:10px">
        <label class="ref-card addon"><div><h4>Waffeln</h4><p class="muted">Frische Waffeln am Stiel (~80 Stk/h)</p></div><input id="waffles_on" type="checkbox"/></label>
        <label class="ref-card addon"><div><h4>Frozen Cappuccino</h4><p class="muted">Sommer‑Favorit</p></div><input id="frozencap_on" type="checkbox"/></label>
        <label class="ref-card addon"><div><h4>Softeis</h4><p class="muted">Perfekt für Affogato</p></div><input id="softice_on" type="checkbox"/></label>
        <label class="ref-card addon"><div><h4>Milchschaumdrucker</h4><p class="muted">Logo/Foto auf Milchschaum</p></div><input id="milkschaum_on" type="checkbox"/></label>
      </div>
      <div class="toolbar"><button class="btn-ghost" id="back5">Zurück</button><button class="btn" id="calc">Preis berechnen</button></div>
      <div id="priceOut" class="pricebox hidden"></div>
    </div>

    <!-- STEP 6 -->
    <div class="card hidden" id="step6">
      <h2>6) Angebot sichern</h2>
      <p class="muted">Wir senden Ihnen das Angebot per E‑Mail zu und reservieren den Termin vorläufig.</p>
      <div class="row">
        <div><label>Name</label><input id="lead_name" placeholder="Max Mustermann"/></div>
        <div><label>E‑Mail</label><input id="lead_email" type="email" placeholder="max@firma.de"/></div>
        <div><label>Telefon</label><input id="lead_phone" placeholder="+49 ..."/></div>
      </div>
      <label style="display:flex;gap:8px;align-items:center;margin-top:8px"><input id="consent" type="checkbox"/> Ich stimme der Verarbeitung meiner Angaben zum Zweck der Angebotserstellung zu.</label>
      <div class="toolbar"><button class="btn-ghost" id="back6">Zurück</button><button class="btn" id="sendLead">Angebot sichern</button></div>
      <div class="info hidden" id="leadMsg"></div>
    </div>
  </div>

  <div style="margin-top:16px">
    <h3>Hinweis</h3>
    <p class="muted">Wochentags‑Zuschläge sind in der Kalkulation bereits berücksichtigt. Zusätzlich gelten tagesabhängige Rabatte und Mehrtages‑Vorteile.</p>
  </div>
</div>

<script>
const state = { date_start:"", date_end:"", location:"", available:false, availabilityDiscount:0, location_lat:null, location_lng:null,
  segment:"", priorities:[], refCategory:"", refSub:"", guests:80, start_time:"09:00", end_time:"13:00",
  addons:{waffles:false,frozencap:false,softice:false,milkschaum:false}, route:null, price:null };
function $(id){ return document.getElementById(id); }
function todayISO(){ const t=new Date(); const y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,'0'), d=String(t.getDate()).padStart(2,'0'); return `${y}-${m}-${d}`; }
function isPastDate(iso){ if(!iso) return true; const t=new Date(todayISO()); const d=new Date(iso); return d<t; }
function daysBetween(a,b){ const s=new Date(a); const e=b?new Date(b):new Date(a); if(isNaN(s)) return 0; if(isNaN(e)) return 1;
  const ms=(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())-Date.UTC(s.getFullYear(),s.getMonth(),s.getDate())); return Math.floor(ms/86400000)+1; }
function formatEUR(v){ return new Intl.NumberFormat('de-DE',{ style:'currency', currency:'EUR'}).format(v); }
function setActive(step){ [1,2,3,4,5,6].forEach(n => $('s'+n).classList.toggle('active', n<=step)); }
function showStep(n){ ['step1','step2','step3','step4','step5','step6'].forEach((id,i)=>$(id).classList.toggle('hidden',(i+1)!==n)); setActive(n); updateSummary(); }
function updateSummary(){
  const d1=state.date_start||'–', d2=state.date_end||state.date_start||'–', days=daysBetween(state.date_start,state.date_end);
  const seg=state.segment||'–', pr=(state.priorities.length?state.priorities.join(', '):'–');
  const disc=state.availabilityDiscount>0? Math.round(state.availabilityDiscount*100)+'% Rabatt':'kein Rabatt';
  $('summary').innerHTML = `<span class="badge">Termin: <strong>${d1}</strong> bis <strong>${d2}</strong> (${days} Tag/e)</span>
  <span class="badge">Ort: <strong>${state.location||'–'}</strong></span>
  <span class="badge">Segment: <strong>${seg}</strong></span>
  <span class="badge">Wichtig: <strong>${pr}</strong></span>
  <span class="badge">Verfügbarkeit: <strong>${state.available?'verfügbar':'unbekannt'}</strong> / <strong>${disc}</strong></span>`;
}

// Step 1
$('date_start').min=todayISO(); $('date_end').min=todayISO(); $('date_start').valueAsDate=new Date();
$('checkAvail').addEventListener('click', ()=>{
  state.date_start=$('date_start').value; state.date_end=$('date_end').value; state.location=$('location').value.trim();
  if(!state.date_start || !state.location) return show('Bitte Datum und Ort/PLZ angeben.','warn');
  if(state.location.length<3) return show('Bitte mindestens 3 Zeichen für Ort/PLZ eingeben.','warn');
  if(isPastDate(state.date_start)) return show('Das Startdatum darf nicht in der Vergangenheit liegen.','warn');
  if(state.date_end && state.date_end<state.date_start) return show('Das Enddatum darf nicht vor dem Startdatum liegen.','warn');
  $('availInfo').className='info'; $('availInfo').classList.remove('hidden'); $('availInfo').textContent='⏳ Wir prüfen die Verfügbarkeit …';
  let finished=false; const watchdog=setTimeout(()=>{ if(!finished){ finalize(null); finished=true; } }, 3500);
  try{
    const hasGoogle=!!(window.google && google.maps);
    if(!hasGoogle){ done(); } else if(google.maps.Geocoder){
      const geocoder=new google.maps.Geocoder();
      geocoder.geocode({ address: state.location, componentRestrictions:{country:'DE'} }, (res,status)=>{ if(finished) return; done(); });
    } else { done(); }
  }catch(e){ done(); }
  function done(){ if(finished) return; finished=true; clearTimeout(watchdog); finalize(null); }
  function finalize(route){
    const r=Math.random(); const disc=r<0.2?0.15:(r<0.65?0.10:0);
    state.available=true; state.availabilityDiscount=disc; $('availInfo').className='info ok';
    $('availInfo').innerHTML = disc>0? `✅ Termin verfügbar. Frühbucher‑Vorteil: <strong>${Math.round(disc*100)}%</strong>.` : '✅ Termin verfügbar.';
    updateSummary(); showStep(2);
  }
});
function show(msg,kind){ const box=$('availInfo'); box.classList.remove('hidden'); box.className='info '+(kind||''); box.textContent=msg; }

// Step 2
$('back2').addEventListener('click',()=>showStep(1));
document.querySelectorAll('#segmentGrid .segment').forEach(el=>el.addEventListener('click',()=>{ document.querySelectorAll('#segmentGrid .segment').forEach(x=>x.classList.remove('active')); el.classList.add('active'); state.segment=el.dataset.value; updateSummary(); }));
$('next2').addEventListener('click',()=>{ if(!state.segment) return alert('Bitte Segment wählen.');
  const cats=Object.keys(REF_MAP); const sel=$('refCategory'); sel.innerHTML=''; cats.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
  sel.value = cats.includes(state.segment)? state.segment : cats[0]; fillSub(); showStep(3);
});

// Step 3
$('back3').addEventListener('click',()=>showStep(2));
document.querySelectorAll('#priorityGrid .choice').forEach(card=>card.addEventListener('click',()=>{ const v=card.dataset.value; const i=state.priorities.indexOf(v); if(i>=0){ state.priorities.splice(i,1); card.classList.remove('active'); } else { state.priorities.push(v); card.classList.add('active'); } updateSummary(); }));
$('next3').addEventListener('click',()=>{ if(!state.priorities.length) return alert('Bitte mindestens eine Priorität wählen.'); showStep(4); });

// Step 4
const REF_MAP = {
  "Privat": {"Hochzeit": {"desc":"Romantische Hochzeiten","img":"latte"}, "Geburtstag": {"desc":"Runde Geburtstage","img":"espresso"}},
  "Gewerblich": {"Messe": {"desc":"Messe‑Catering","img":"espresso"}, "Eröffnung": {"desc":"Geschäftseröffnungen","img":"latte"}},
  "Agenturen / Wiederverkäufer": {"Promotion": {"desc":"White‑Label & Promotion","img":"espresso"}},
  "Allgemein": {"Coffee‑Car Flotte": {"desc":"Unsere Fahrzeuge","img":"latte"}}
};
$('refCategory').addEventListener('change',fillSub); $('refSub').addEventListener('change',renderRefs);
function fillSub(){ const cat=$('refCategory').value; const subs=Object.keys(REF_MAP[cat]||{}); const sel=$('refSub'); sel.innerHTML=''; subs.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); }); renderRefs(); }
function renderRefs(){ const cat=$('refCategory').value, sub=$('refSub').value; state.refCategory=cat; state.refSub=sub; const grid=$('refGrid'); grid.innerHTML='';
  if(!cat||!sub||!REF_MAP[cat]||!REF_MAP[cat][sub]) return; const item=REF_MAP[cat][sub];
  const card=document.createElement('div'); card.className='ref-card'; card.innerHTML=(item.img==='espresso'?`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 220 140" width="320">
  <defs><linearGradient id="a" x1="0" x2="1"><stop offset="0" stop-color="#c48a5a"/><stop offset="1" stop-color="#8b5b2e"/></linearGradient></defs>
  <rect rx="16" ry="16" x="5" y="5" width="210" height="130" fill="#f4f7f6" stroke="#e6e8eb"/>
  <g transform="translate(30,25)">
    <rect x="0" y="0" width="160" height="18" rx="9" fill="#1A1F2B"/>
    <rect x="10" y="28" width="60" height="8" rx="4" fill="#9aa3b2"/>
    <rect x="90" y="28" width="20" height="8" rx="4" fill="#9aa3b2"/>
    <path d="M78,18 v34" stroke="#1A1F2B" stroke-width="6" stroke-linecap="round"/>
    <rect x="62" y="52" width="32" height="22" rx="5" fill="#ddd"/>
    <rect x="58" y="76" width="40" height="22" rx="8" fill="url(#a)"/>
    <rect x="52" y="98" width="52" height="8" rx="4" fill="#6b4b2a"/>
  </g>
</svg>`:`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 220 140" width="320">
  <rect rx="16" ry="16" x="5" y="5" width="210" height="130" fill="#f4f7f6" stroke="#e6e8eb"/>
  <g transform="translate(60,25)">
    <ellipse cx="50" cy="18" rx="50" ry="16" fill="#d2e7e2"/>
    <ellipse cx="50" cy="18" rx="46" ry="12" fill="#ffffff"/>
    <rect x="4" y="18" width="92" height="52" rx="10" fill="#ffffff"/>
    <rect x="4" y="70" width="92" height="30" rx="10" fill="#e8f2ef"/>
    <path d="M12 40 C30 20, 70 20, 88 40 C70 60, 30 60, 12 40 Z" fill="#f2c9a6"/>
    <circle cx="95" cy="44" r="10" fill="none" stroke="#9acabc" stroke-width="6"/>
  </g>
</svg>`)+`<div><h4>${cat} → ${sub}</h4><p class='muted'>${item.desc||''}</p></div>`; grid.appendChild(card);
}
$('back4').addEventListener('click',()=>showStep(3)); $('next4').addEventListener('click',()=>showStep(5));

// Step 5
$('back5').addEventListener('click',()=>showStep(4));
$('calc').addEventListener('click',()=>{
  state.guests=parseInt($('guests').value||'0',10); state.start_time=$('start_time').value; state.end_time=$('end_time').value;
  state.addons.waffles=$('waffles_on').checked; state.addons.frozencap=$('frozencap_on').checked; state.addons.softice=$('softice_on').checked; state.addons.milkschaum=$('milkschaum_on').checked;
  const [h1,m1]=state.start_time.split(':').map(Number); const [h2,m2]=state.end_time.split(':').map(Number); const hrs=Math.max(1,(h2*60+m2-(h1*60+m1))/60); const days=daysBetween(state.date_start,state.date_end);

  function weekday(d){ const wd=new Date(d).getDay(); return wd; } // 0=So … 6=Sa
  const wd=weekday(state.date_start);
  let base = (wd===0?950:(wd===6?890:790));
  if(hrs>4) base += (hrs-4)*120;
  if(state.guests>50) base += (state.guests-50)*3.5;
  if(state.addons.waffles) base += 220;
  if(state.addons.frozencap) base += 180;
  if(state.addons.softice) base += 260;
  if(state.addons.milkschaum) base += 150;
  let helper = 0; if(state.guests>=120) helper = Math.max(4, hrs)*29;

  let dayDisc=0; if(days===2) dayDisc=0.20; if(days>=3) dayDisc=0.25;
  const availDisc = state.availabilityDiscount;

  const DEPOTS=[{name:'Frankfurt',lat:50.1109,lng:8.6821},{name:'Stuttgart',lat:48.7758,lng:9.1829},{name:'München',lat:48.1351,lng:11.5820},{name:'Singen',lat:47.7649,lng:8.8421},{name:'Düsseldorf',lat:51.2277,lng:6.7735}];
  function toRad(x){return x*Math.PI/180;} function hav(a,b){const R=6371; const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng), lat1=toRad(a.lat), lat2=toRad(b.lat); const h=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2; return 2*R*Math.asin(Math.sqrt(h)); }
  let travel=0; if(state.location_lat && state.location_lng){ const p={lat:state.location_lat,lng:state.location_lng}; let best=null; DEPOTS.forEach(d=>{const km=hav(p,d); if(!best||km<best.km) best={depot:d,km};}); const bill=Math.max(0,best.km-30); travel=bill*0.80; }

  let subtotal = base + helper + travel; subtotal = subtotal*(1-availDisc)*(1-dayDisc);
  const NET = Math.round(subtotal); const GROSS = Math.round(NET*1.19);
  state.price={net:NET,gross:GROSS,base,helper,travel,hrs,days,availDisc,dayDisc};
  const out=$('priceOut'); out.classList.remove('hidden');
  out.innerHTML = `<div><strong>Preisvorschlag (Brutto):</strong> ${formatEUR(GROSS)}</div>
    <div class="muted">Netto: ${formatEUR(NET)} • Basis: ${formatEUR(base)} • Helfer: ${formatEUR(helper)} • Anfahrt: ${formatEUR(travel)} • Rabatte: Verfügbarkeit −${Math.round(availDisc*100)}% • Mehrtägig −${Math.round(dayDisc*100)}% • Dauer: ${hrs} h</div>`;
  showStep(6);
});

// Step 6
$('back6').addEventListener('click',()=>showStep(5));
(function(){ const send=$('sendLead'); const c=$('consent'); function u(){ send.disabled=!c.checked; } c.addEventListener('change',u); u(); })();
$('sendLead').addEventListener('click', async ()=>{
  const name=$('lead_name').value.trim(), email=$('lead_email').value.trim(), phone=$('lead_phone').value.trim();
  if(!name||!email) return alert('Bitte Name und E‑Mail angeben.');
  const params=new URLSearchParams({mode:'lead',name,email,phone, date_start:state.date_start,date_end:state.date_end,location:state.location, segment:state.segment,priority:(state.priorities||[]).join(', '), ref_cat:state.refCategory,ref_sub:state.refSub, guests:state.guests,start_time:state.start_time,end_time:state.end_time, price_net: state.price? state.price.net:'', price_gross: state.price? state.price.gross:''});
  const box=$('leadMsg'); box.classList.remove('hidden'); box.className='info'; box.textContent='⏳ Sende Anfrage …';
  try{ const r=await fetch('https://script.google.com/macros/s/AKfycbw4-wgD6hQFoPHGtbew27ysmR8q0NokxGfV_ym2PKgMi5bt415b-PrtG12tKbUXwCpxeg/exec?'+params.toString()); const j=await r.json(); if(j.ok){ box.className='info ok'; box.innerHTML='✅ Danke! Wir melden uns kurzfristig mit einem Angebot.'; } else { box.className='info warn'; box.textContent='⚠️ Konnte nicht gesendet werden: '+(j.error||'Unbekannt'); } }catch(e){ box.className='info warn'; box.textContent='⚠️ Netzwerkfehler: '+e.message; }
});

// Init + optional Places
showStep(1);
function initAutocomplete(){
  try{ if(!(window.google && google.maps && google.maps.places && google.maps.places.Autocomplete)) return;
    const input=$('location'); const ac=new google.maps.places.Autocomplete(input, { fields:['formatted_address','geometry'], componentRestrictions:{country:['de']}, types:['geocode'] });
    ac.addListener('place_changed', ()=>{ const p=ac.getPlace(); if(p && p.geometry){ state.location = p.formatted_address||input.value.trim(); state.location_lat=p.geometry.location.lat(); state.location_lng=p.geometry.location.lng(); } });
  }catch(e){}
}
document.addEventListener('DOMContentLoaded',initAutocomplete); window.addEventListener('load',initAutocomplete);
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBIRGZPccaGFYnieQTR8gbAox2KDL0pgoQ&libraries=places"></script>

<script>
(function(){ 
  const el = document.getElementById('brandLogo');
  const primary = "data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20360%20100%22%20width%3D%22180%22%20aria-label%3D%22Coffee%E2%80%91Car%22%3E%0A%20%20%3Cdefs%3E%3ClinearGradient%20id%3D%22g%22%20x1%3D%220%22%20x2%3D%221%22%3E%3Cstop%20offset%3D%220%22%20stop-color%3D%22%238BC4B5%22/%3E%3Cstop%20offset%3D%221%22%20stop-color%3D%22%235DB6A1%22/%3E%3C/linearGradient%3E%3C/defs%3E%0A%20%20%3Cg%20fill%3D%22none%22%20stroke%3D%22url%28%23g%29%22%20stroke-width%3D%2210%22%20stroke-linecap%3D%22round%22%3E%0A%20%20%20%20%3Cpath%20d%3D%22M20%2C70%20C50%2C20%20110%2C20%20140%2C70%22/%3E%0A%20%20%20%20%3Cpath%20d%3D%22M80%2C70%20C110%2C20%20170%2C20%20200%2C70%22/%3E%0A%20%20%3C/g%3E%0A%20%20%3Ccircle%20cx%3D%2285%22%20cy%3D%2278%22%20r%3D%2210%22%20fill%3D%22%230F766E%22/%3E%0A%20%20%3Ccircle%20cx%3D%22205%22%20cy%3D%2278%22%20r%3D%2210%22%20fill%3D%22%230F766E%22/%3E%0A%20%20%3Ctext%20x%3D%22220%22%20y%3D%2245%22%20font-size%3D%2228%22%20font-family%3D%22Inter%2Csystem-ui%2CSegoe%20UI%2CRoboto%2CArial%22%20fill%3D%22%231A1F2B%22%20font-weight%3D%22800%22%3ECoffee%E2%80%91Car%3C/text%3E%0A%20%20%3Ctext%20x%3D%22220%22%20y%3D%2272%22%20font-size%3D%2214%22%20font-family%3D%22Inter%2Csystem-ui%2CSegoe%20UI%2CRoboto%2CArial%22%20fill%3D%22%233B4150%22%3EProfessional%20Coffee%20Catering%3C/text%3E%0A%3C/svg%3E";
  const mono = "data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20360%20100%22%20width%3D%22180%22%20aria-label%3D%22Coffee%E2%80%91Car%20mono%22%3E%0A%20%20%3Cg%20fill%3D%22none%22%20stroke%3D%22%230F766E%22%20stroke-width%3D%2210%22%20stroke-linecap%3D%22round%22%3E%0A%20%20%20%20%3Cpath%20d%3D%22M20%2C70%20C50%2C20%20110%2C20%20140%2C70%22/%3E%0A%20%20%20%20%3Cpath%20d%3D%22M80%2C70%20C110%2C20%20170%2C20%20200%2C70%22/%3E%0A%20%20%3C/g%3E%0A%20%20%3Ccircle%20cx%3D%2285%22%20cy%3D%2278%22%20r%3D%2210%22%20fill%3D%22%230F766E%22/%3E%0A%20%20%3Ccircle%20cx%3D%22205%22%20cy%3D%2278%22%20r%3D%2210%22%20fill%3D%22%230F766E%22/%3E%0A%20%20%3Ctext%20x%3D%22220%22%20y%3D%2245%22%20font-size%3D%2228%22%20font-family%3D%22Inter%2Csystem-ui%2CSegoe%20UI%2CRoboto%2CArial%22%20fill%3D%22%231A1F2B%22%20font-weight%3D%22800%22%3ECoffee%E2%80%91Car%3C/text%3E%0A%20%20%3Ctext%20x%3D%22220%22%20y%3D%2272%22%20font-size%3D%2214%22%20font-family%3D%22Inter%2Csystem-ui%2CSegoe%20UI%2CRoboto%2CArial%22%20fill%3D%22%233B4150%22%3EProfessional%20Coffee%20Catering%3C/text%3E%0A%3C/svg%3E";
  const compact = "data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20120%20120%22%20width%3D%2256%22%20aria-label%3D%22CC%20monogram%22%3E%0A%20%20%3Cdefs%3E%3ClinearGradient%20id%3D%22gc%22%20x1%3D%220%22%20x2%3D%221%22%3E%3Cstop%20offset%3D%220%22%20stop-color%3D%22%238BC4B5%22/%3E%3Cstop%20offset%3D%221%22%20stop-color%3D%22%235DB6A1%22/%3E%3C/linearGradient%3E%3C/defs%3E%0A%20%20%3Ccircle%20cx%3D%2260%22%20cy%3D%2260%22%20r%3D%2256%22%20fill%3D%22%23ffffff%22%20stroke%3D%22%23E6E8EB%22/%3E%0A%20%20%3Cpath%20d%3D%22M36%2060a24%2024%200%201%201%200%200%22%20fill%3D%22none%22%20stroke%3D%22url%28%23gc%29%22%20stroke-width%3D%2210%22%20stroke-linecap%3D%22round%22/%3E%0A%20%20%3Cpath%20d%3D%22M76%2060a24%2024%200%201%201%200%200%22%20fill%3D%22none%22%20stroke%3D%22%230F766E%22%20stroke-width%3D%2210%22%20stroke-linecap%3D%22round%22/%3E%0A%3C/svg%3E";
  const b1=document.getElementById('logoPrimaryBtn'), b2=document.getElementById('logoMonoBtn'), b3=document.getElementById('logoCompactBtn');
  if(b1) b1.addEventListener('click', ()=>{ el.src = primary; });
  if(b2) b2.addEventListener('click', ()=>{ el.src = mono; });
  if(b3) b3.addEventListener('click', ()=>{ el.src = compact; });
})();
</script>

</body>
</html>
