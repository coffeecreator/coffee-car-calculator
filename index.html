<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Coffee‑Car Wizard · v1 Final (Stabil)</title>
<style>
  :root{ --mint:#8BC4B5; --mint-strong:#5DB6A1; --ink:#1A1F2B; --ink-soft:#3B4150; --bg:#FAFBFC; --card:#FFFFFF; --line:#E6E8EB; --muted:#6B7280; --accent:#0F766E; --radius:16px; }
  *{box-sizing:border-box} body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink)}
  .wrap{max-width:1100px; margin:auto; padding:22px}
  .header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
  .brand{display:flex; align-items:center; gap:10px}
  .chip{display:inline-block; padding:6px 10px; border-radius:999px; background:linear-gradient(90deg,#fff,#f4fffb); border:1px solid var(--line); color:var(--accent); font-weight:700}
  h1{margin:0; font-size:clamp(20px,3.5vw,30px)}
  .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:18px; box-shadow:0 4px 18px rgba(0,0,0,.04)}
  .muted{color:var(--muted)}
  .row{display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  label{display:block; font-weight:700; margin:6px 0 6px}
  input,select,button,textarea{width:100%; padding:12px; border-radius:12px; border:1px solid var(--line); background:#fff; color:var(--ink)}
  input:focus,select:focus,textarea:focus{outline:2px solid var(--mint); outline-offset:1px}
  textarea{min-height:96px}
  .btn{cursor:pointer; font-weight:900; background:linear-gradient(90deg,var(--mint),var(--mint-strong)); border:none; color:#083B35}
  .btn-ghost{background:transparent; border:1px solid var(--line); color:var(--ink)}
  .toolbar{display:flex; gap:10px; justify-content:flex-end; margin-top:12px}
  .steps{display:flex; gap:8px; align-items:center; margin:12px 0 16px}
  .dot{width:11px; height:11px; border-radius:50%; background:#d7e7e3; border:1px solid #cfe7df}
  .dot.active{background:var(--mint); border-color:var(--mint-strong)}
  .hidden{display:none !important}
  .info{display:flex; gap:12px; align-items:flex-start; padding:10px; border:1px dashed var(--line); border-radius:12px; background:#F6FAF9; margin-top:8px}
  .ok{color:#0C3F37} .warn{color:#8B5E00}
  .pricebox{display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:999px; background:#F3F7F6; border:1px dashed var(--line); color:var(--accent); margin-top:10px}
  .grid2{display:grid; grid-template-columns:1fr; gap:18px}
  .ref-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px}
  .ref-card{border:1px solid var(--line); border-radius:14px; padding:12px; background:#fff}
  .ref-card h4{margin:0 0 4px 0} .ref-card p{margin:0; color:var(--muted)}
  .ref-actions{display:flex; gap:8px; margin-top:8px}
  .badge{display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; background:#EEF7F5; border:1px solid var(--line); color:#0C3F37}

  /* Light-only: Darkmode bewusst neutralisiert */
  body.dark{ --bg:#FAFBFC; --card:#FFFFFF; --line:#E6E8EB; --ink:#1A1F2B; --ink-soft:#3B4150; --accent:#0F766E; }
</style>
</head>
<body>
<div class="wrap">
  <div id="summary" class="hidden"></div>
  <div class="header">
    <div class="brand"><h1>Coffee‑Car Buchungs‑Wizard</h1></div>
    <div class="steps">
      <div class="dot" id="s1"></div><div class="dot" id="s2"></div><div class="dot" id="s3"></div>
      <div class="dot" id="s4"></div><div class="dot" id="s5"></div><div class="dot" id="s6"></div>
    </div>
  </div>

  <div class="grid2">
    <div class="card" id="step1">
      <h2>1) Wann &amp; Wo findet das Event statt?</h2>
      <div class="row">
        <div><label>Datum (Start)</label><input id="date_start" type="date"/></div>
        <div><label>Datum (Ende)</label><input id="date_end" placeholder="optional" type="date"/></div>
        <div><label>Ort / PLZ</label><input id="location" placeholder="z. B. 60313 Frankfurt"/></div>
      </div>
      <div class="toolbar">
        <button class="btn" id="checkAvail">Verfügbarkeit prüfen</button>
      </div>
      <div class="info hidden" id="availInfo"></div>
    </div>

    <div class="card hidden" id="step2">
      <h2>2) Wer fragt an?</h2>
      <div id="segmentGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-top:12px">
        <div class="ref-card segment" data-value="Privat"><h4>Privat</h4><p>Hochzeiten, Geburtstage, Familienfeiern</p></div>
        <div class="ref-card segment" data-value="Gewerblich"><h4>Gewerblich</h4><p>Firmenfeiern, Messen, Eröffnungen</p></div>
        <div class="ref-card segment" data-value="Agenturen / Wiederverkäufer"><h4>Agenturen / Wiederverkäufer</h4><p>Partner, White‑Label, Promotion-Einsätze</p></div>
        <div class="ref-card segment" data-value="Behörden / Öffentliche Einrichtungen"><h4>Behörden / Öffentliche Einrichtungen</h4><p>Schulen, Ämter, Stadtverwaltungen</p></div>
      </div>
      <div class="toolbar">
        <button class="btn-ghost" id="back2">Zurück</button>
        <button class="btn" id="next2">Weiter</button>
      </div>
    </div>

    <div class="card hidden" id="step3">
      <h2>3) Was ist Ihnen besonders wichtig?</h2>
      <div id="priorityGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;margin-top:12px">
        <div class="ref-card choice" data-value="Preis &amp; Wirtschaftlichkeit">Preis &amp; Wirtschaftlichkeit</div>
        <div class="ref-card choice" data-value="Einfach &amp; Zuverlässig">Einfach &amp; Zuverlässig</div>
        <div class="ref-card choice" data-value="Qualität &amp; Auftritt">Qualität &amp; Auftritt</div>
        <div class="ref-card choice" data-value="Luxus &amp; Individualisierung">Luxus &amp; Individualisierung</div>
        <div class="ref-card choice" data-value="Nachhaltigkeit">Nachhaltigkeit</div>
        <div class="ref-card choice" data-value="Faire Löhne">Faire Löhne</div>
        <div class="ref-card choice" data-value="Große Auswahl an Milchalternativen">Große Auswahl an Milchalternativen</div>
        <div class="ref-card choice" data-value="Barista mit Latte‑Art‑Skill">Barista mit Latte‑Art‑Skill</div>
      </div>
      <div class="toolbar">
        <button class="btn-ghost" id="back3">Zurück</button>
        <button class="btn" id="next3">Weiter</button>
      </div>
    </div>

    <div class="card hidden" id="step4">
      <h2>4) Passende Referenzen</h2>
      <p class="muted">Aus über 3.000 Coffee‑Events zeigen wir Ihnen passende Beispiele.</p>
      <div class="row">
        <div><label>Kategorie</label><select id="refCategory"></select></div>
        <div><label>Unterkategorie</label><select id="refSub"></select></div>
      </div>
      <div class="ref-grid" id="refGrid" style="margin-top:12px"></div>
      <div class="toolbar">
        <button class="btn-ghost" id="back4">Zurück</button>
        <button class="btn" id="next4">Weiter</button>
      </div>
    </div>

    <div class="card hidden" id="step5">
      <h2>5) Preis &amp; Optionen</h2>
      <div class="row">
        <div><label>Gästezahl</label><input id="guests" min="1" type="number" value="80"/></div>
        <div><label>Ausschankbeginn</label><input id="start_time" type="time" value="09:00"/></div>
        <div><label>Ausschankende</label><input id="end_time" type="time" value="13:00"/></div>
        <div>
          <label>Becher / Tassen</label>
          <select id="cupType">
            <option>Einwegbecher (kompostierbar)</option>
            <option>Porzellantassen</option>
            <option>Kunde stellt Tassen</option>
            <option>Branding‑Becher</option>
          </select>
        </div>
      </div>

      <div id="addonsGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:8px">
        <label class="ref-card addon"><div><h4>Waffeln</h4><p>Frische Waffeln am Stiel (~80 Stk/h)</p></div><input id="waffles_on" type="checkbox"/></label>
        <label class="ref-card addon"><div><h4>Frozen Cappuccino</h4><p>Cremig-gekühlt – Sommer-Favorit</p></div><input id="frozencap_on" type="checkbox"/></label>
        <label class="ref-card addon"><div><h4>Softeis</h4><p>Vanille/Schoko – perfekt für Affogato</p></div><input id="softice_on" type="checkbox"/></label>
        <label class="ref-card addon"><div><h4>Milchschaumdrucker</h4><p>Logo/Foto/Schrift direkt auf Milchschaum</p></div><input id="milkschaum_on" type="checkbox"/></label>
      </div>

      <div class="toolbar">
        <button class="btn-ghost" id="back5">Zurück</button>
        <button class="btn" id="calc">Preis berechnen</button>
      </div>
      <div class="pricebox hidden" id="priceOut"></div>
    </div>

    <div class="card hidden" id="step6">
      <h2>6) Angebot sichern</h2>
      <p class="muted">Wir senden Ihnen das Angebot per E‑Mail zu und reservieren den Termin vorläufig.</p>
      <div class="row">
        <div><label>Name</label><input id="lead_name" placeholder="Max Mustermann"/></div>
        <div><label>E‑Mail</label><input id="lead_email" placeholder="max@firma.de" type="email"/></div>
        <div><label>Telefon</label><input id="lead_phone" placeholder="+49 ..."/></div>
      </div>
      <div class="row">
        <label><input id="consent" type="checkbox"/> Ich stimme der Verarbeitung meiner Angaben zum Zweck der Angebotserstellung zu.</label>
      </div>
      <div class="toolbar">
        <button class="btn-ghost" id="back6">Zurück</button>
        <button class="btn" id="sendLead">Angebot sichern</button>
      </div>
      <div class="info hidden" id="leadMsg"></div>
    </div>
  </div>

  <div style="margin-top:16px">
    <h3>Hinweis</h3>
    <p class="muted">Wochentags‑Zuschläge sind in der Kalkulation bereits berücksichtigt. Zusätzlich gelten tagesabhängige Rabatte und Mehrtages‑Vorteile.</p>
  </div>
</div>

<script>
// ---- Global State (vorab definieren, damit alle Blöcke darauf zugreifen können) ----
const state = {
  date_start: "", date_end: "", location: "",
  location_lat: null, location_lng: null,
  available: false, availabilityDiscount: 0,
  segment: "", priorities: [],
  refCategory: "", refSub: "",
  guests: 80, start_time: "09:00", end_time: "13:00",
  addons: { waffles:false, frozencap:false, softice:false, milkschaum:false },
  route: null,
  price: null
};
function $(id){ return document.getElementById(id); }
function todayISO(){ const t=new Date(); const y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,'0'), d=String(t.getDate()).padStart(2,'0'); return `${y}-${m}-${d}`; }
function isPastDate(iso){ if(!iso) return true; const t=new Date(todayISO()); const d=new Date(iso); return d<t; }
function setActive(step){ [1,2,3,4,5,6].forEach(n => $('s'+n).classList.toggle('active', n <= step)); }
function showStep(n){ ['step1','step2','step3','step4','step5','step6'].forEach((id,i)=>{ $(id).classList.toggle('hidden', (i+1)!==n); }); setActive(n); updateSummary(); }
function daysBetween(start,end){ const s=new Date(start); const e=end?new Date(end):new Date(start); if(isNaN(s)) return 0; if(isNaN(e)) return 1; const ms=(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())-Date.UTC(s.getFullYear(),s.getMonth(),s.getDate())); return Math.floor(ms/86400000)+1; }
function formatEUR(v){ return new Intl.NumberFormat('de-DE',{ style:'currency', currency:'EUR'}).format(v); }
function simulateAvailability(){ const r=Math.random(); if(r<0.20) return 0.15; else if(r<0.65) return 0.10; return 0.00; }

// ---- Depots & Distanz ----
const DEPOTS = [
  {name:'Frankfurt (HQ)', lat:50.1109, lng:8.6821},
  {name:'Stuttgart',      lat:48.7758, lng:9.1829},
  {name:'München',        lat:48.1351, lng:11.5820},
  {name:'Singen',         lat:47.7649, lng:8.8421},
  {name:'Düsseldorf',     lat:51.2277, lng:6.7735},
];
const KM_FREE = 30; const KM_RATE = 0.80;
function toRad(x){ return x*Math.PI/180; }
function haversineKm(a,b){ const R=6371, dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng), lat1=toRad(a.lat), lat2=toRad(b.lat); const h=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2; return 2*R*Math.asin(Math.sqrt(h)); }
function nearestDepotTo(lat,lng){ const p={lat,lng}; let best=null; DEPOTS.forEach(d=>{ const km=haversineKm(p,d); if(!best||km<best.km) best={depot:d, km}; }); return best; }

// ---- Referenzen (Placeholder) ----
const REF_MAP = {
  "Privat": {"Hochzeit": {"link":"#", "desc":"Romantische Hochzeiten"}, "Geburtstag": {"link":"#", "desc":"Private Geburtstagsfeiern"}},
  "Gewerblich": {"Messe Autohaus": {"link":"#", "desc":"Autohaus-Promotion"}, "Eröffnung": {"link":"#", "desc":"Geschäftseröffnungen"}},
  "Agenturen / Wiederverkäufer": {"Promotion / Subbrand": {"link":"#", "desc":"White-Label- & Partner-Einsätze"}},
  "Allgemein": {"Coffee-Car Flotte": {"link":"#", "desc":"Übersicht Fahrzeuge"}}
};

// ---- Summary (FIXED) ----
function updateSummary(){
  const d1=state.date_start||'–';
  const d2=state.date_end||state.date_start||'–';
  const days=daysBetween(state.date_start,state.date_end);
  const seg=state.segment||'–';
  const pr=(state.priorities&&state.priorities.length)?state.priorities.join(', '):'–';
  const disc=state.availabilityDiscount>0? Math.round(state.availabilityDiscount*100)+'% Frühbucher-Rabatt':'kein Rabatt';
  const html = `
    <div class="badge">Termin: <strong>${d1}</strong> bis <strong>${d2}</strong> (${days} Tag/e)</div>
    <div style="margin-top:6px" class="badge">Ort: <strong>${state.location||'–'}</strong></div>
    <div style="margin-top:6px" class="badge">Segment: <strong>${seg}</strong></div>
    <div style="margin-top:6px" class="badge">Wichtig: <strong>${pr}</strong></div>
    <div style="margin-top:6px" class="badge">Verfügbarkeit: <strong>${state.available? 'verfügbar' : 'unbekannt'}</strong> / Rabatt: <strong>${disc}</strong></div>
  `;
  if($('summary')) $('summary').innerHTML=html;
}
// Light only (kein echter Darkmode-Toggle mehr)
document.body.classList.remove('dark');

// ---- Step 1: Verfügbarkeit ----
$('checkAvail').addEventListener('click', ()=>{
  state.date_start = $('date_start').value;
  state.date_end = $('date_end').value;
  state.location = $('location').value.trim();

  if(!state.date_start || !state.location){
    $('availInfo').className='info warn'; $('availInfo').textContent='Bitte Datum und Ort/PLZ angeben.'; $('availInfo').classList.remove('hidden'); return;
  }
  if(isPastDate(state.date_start)){
    $('availInfo').className='info warn'; $('availInfo').textContent='Das Startdatum darf nicht in der Vergangenheit liegen.'; $('availInfo').classList.remove('hidden'); return;
  }
  if(state.date_end && state.date_end < state.date_start){
    $('availInfo').className='info warn'; $('availInfo').textContent='Das Enddatum darf nicht vor dem Startdatum liegen.'; $('availInfo').classList.remove('hidden'); return;
  }

  $('availInfo').className='info'; $('availInfo').innerHTML='⏳ Wir prüfen die Verfügbarkeit …'; $('availInfo').classList.remove('hidden');

  // Falls Google verfügbar ist, Geocode + Distanz, andernfalls direkt erfolgreich
  const useMaps = !!(window.google && google.maps && (google.maps.Geocoder || google.maps.DistanceMatrixService));
  const proceedAvailability = (route)=>{
    const disc = simulateAvailability();
    state.available = true; state.availabilityDiscount = disc; state.route = route||null;
    const routeLine = route ? `<br><small><strong>Nahe Standort:</strong> ${route.depot||'–'} • <strong>Strecke:</strong> ${route.distanceText||'–'} ${route.durationText? '• <strong>Dauer:</strong> '+route.durationText:''}</small>` : '';
    $('availInfo').className='info ok';
    $('availInfo').innerHTML = disc>0 ? `✅ Gute Nachrichten: Termin verfügbar. Frühbucher-Vorteil: <strong>${Math.round(disc*100)}%</strong>.` + routeLine
                               : `✅ Termin verfügbar. Für diesen Tag sind aktuell <strong>keine zusätzlichen Rabatte</strong> vorgesehen.` + routeLine;
    updateSummary(); showStep(2);
  };

  if(!useMaps){ proceedAvailability(null); return; }

  function handleLatLng(lat,lng){
    const best = nearestDepotTo(lat,lng);
    if(google.maps.DistanceMatrixService){
      const svc = new google.maps.DistanceMatrixService();
      svc.getDistanceMatrix({ origins:[{lat:best.depot.lat,lng:best.depot.lng}], destinations:[{lat,lng}], travelMode: google.maps.TravelMode.DRIVING }, (res, dmStatus)=>{
        let distanceText = `${best.km.toFixed(1)} km (Luftlinie)`;
        let durationText = ''; let distanceKm = best.km;
        try{
          if(dmStatus==='OK' && res.rows[0].elements[0].status==='OK'){
            const elem = res.rows[0].elements[0];
            distanceText = elem.distance.text; durationText = elem.duration.text;
            distanceKm = (elem.distance.value||0)/1000;
          }
        }catch(e){}
        proceedAvailability({ depot: best.depot.name, distanceText, durationText, distanceKm, source:'dm' });
      });
    }else{
      proceedAvailability({ depot: best.depot.name, distanceText:`${best.km.toFixed(1)} km (Luftlinie)`, durationText:'', distanceKm:best.km, source:'haversine' });
    }
  }

  if(state.location_lat!=null && state.location_lng!=null){ handleLatLng(state.location_lat, state.location_lng); }
  else if(google.maps.Geocoder){
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ address: state.location, componentRestrictions:{ country:'DE' } }, (results,status)=>{
      if(status!=='OK' || !results || !results[0]){ proceedAvailability(null); return; }
      const loc = results[0].geometry.location; handleLatLng(loc.lat(), loc.lng());
    });
  } else {
    proceedAvailability(null);
  }
});

// ---- Step 2 (Segment) ----
$('back2').addEventListener('click', ()=> showStep(1));
document.querySelectorAll('#segmentGrid .segment').forEach(card=>{
  card.addEventListener('click', ()=>{
    document.querySelectorAll('#segmentGrid .segment').forEach(c=>c.classList.remove('active'));
    card.classList.add('active');
    state.segment = card.dataset.value; updateSummary();
  });
});
$('next2').addEventListener('click', ()=>{
  if(!state.segment) return alert('Bitte Segment wählen.');
  const cats = Object.keys(REF_MAP); const selCat = $('refCategory'); selCat.innerHTML='';
  cats.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; selCat.appendChild(o); });
  if(cats.includes(state.segment)) selCat.value=state.segment;
  fillSubcategories(); showStep(3);
});

// ---- Step 3 (Prioritäten) ----
function fillSubcategories(){
  const cat = $('refCategory').value; const subs = Object.keys(REF_MAP[cat]||{});
  const sel = $('refSub'); sel.innerHTML=''; subs.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });
  renderRefs();
}
$('back3').addEventListener('click', ()=> showStep(2));
document.querySelectorAll('#priorityGrid .choice').forEach(card=>{
  card.addEventListener('click', ()=>{
    const val = card.dataset.value;
    const idx = state.priorities.indexOf(val);
    if(idx>=0){ state.priorities.splice(idx,1); card.classList.remove('active'); }
    else{ state.priorities.push(val); card.classList.add('active'); }
    updateSummary();
  });
});
$('next3').addEventListener('click', ()=>{
  if(!state.priorities.length) return alert('Bitte wählen Sie mindestens eine Priorität.');
  showStep(4);
});

// ---- Step 4 (Referenzen) ----
$('refCategory').addEventListener('change', fillSubcategories);
$('refSub').addEventListener('change', renderRefs);
function renderRefs(){
  const cat = $('refCategory').value; const sub = $('refSub').value;
  state.refCategory = cat; state.refSub = sub;
  const grid = $('refGrid'); grid.innerHTML='';
  if(!cat || !sub || !REF_MAP[cat] || !REF_MAP[cat][sub]) return;
  const item = REF_MAP[cat][sub];
  const card = document.createElement('div'); card.className='ref-card';
  card.innerHTML = `<h4>${cat} → ${sub}</h4><p>${item.desc||''}</p><div class="ref-actions"><a class="btn-ghost" href="${item.link||'#'}" target="_blank" rel="noopener">Ordner öffnen</a></div>`;
  grid.appendChild(card);
}
$('back4').addEventListener('click', ()=> showStep(3));
$('next4').addEventListener('click', ()=> showStep(5));

// ---- Step 5 (Kalkulator) ----
$('back5').addEventListener('click', ()=> showStep(4));
const API = "https://script.google.com/macros/s/AKfycbw4-wgD6hQFoPHGtbew27ysmR8q0NokxGfV_ym2PKgMi5bt415b-PrtG12tKbUXwCpxeg/exec";
function normalizePriceNumber(raw){
  if(raw == null) return 0;
  const digits = String(raw).replace(/\D/g,''); if(digits.length >= 3){ return parseInt(digits.slice(0,-2),10) + parseInt(digits.slice(-2),10)/100; }
  let s = String(raw).replace(/[^0-9,.-]/g,'').trim();
  if (/^\d{1,3}(\.\d{3})+,\d{2}$/.test(s)) s = s.replace(/\./g,'').replace(',', '.'); else if (/^\d+,\d{2}$/.test(s)) s = s.replace(',', '.'); else if (/^\d+\.\d{2}$/.test(s)) {/*ok*/} else { const last=s.lastIndexOf(','); if(last!==-1) s=s.slice(0,last).replace(/\./g,'')+'.'+s.slice(last+1); else s=s.replace(/\./g,''); }
  let num=parseFloat(s); if(!isFinite(num)||isNaN(num)) num=0; if(num>20000) num=num/100; return num;
}
$('calc').addEventListener('click', async ()=>{
  state.guests = parseInt($('guests').value||'0',10);
  state.start_time = $('start_time').value; state.end_time = $('end_time').value;
  state.addons.waffles = $('waffles_on').checked; state.addons.frozencap = $('frozencap_on').checked; state.addons.softice = $('softice_on').checked; state.addons.milkschaum = $('milkschaum_on').checked;
  const [h1,m1]=state.start_time.split(':').map(Number); const [h2,m2]=state.end_time.split(':').map(Number); const hrs=Math.max(1, (h2*60+m2 - (h1*60+m1))/60);
  const days = daysBetween(state.date_start,state.date_end);

  const params = new URLSearchParams({
    date_start: state.date_start, date_end: state.date_end,
    start_time: state.start_time, end_time: state.end_time,
    guests: String(state.guests),
    customer_type: (state.segment==='Privat')?'Privat':'Gewerblich',
    event_type: (state.priorities && state.priorities[0]) ? state.priorities[0] : 'Sonstige',
    cupType: $('cupType').value,
    waffles_on: state.addons.waffles?'1':'0',
    frozencap_on: state.addons.frozencap?'1':'0',
    softice_on: state.addons.softice?'1':'0',
    milkschaum_on: state.addons.milkschaum?'1':'0'
  });

  const out = $('priceOut'); out.classList.remove('hidden'); out.textContent = '⏳ Preis wird berechnet …';
  let base = 0;
  try { const r = await fetch(`${API}?${params.toString()}`); const j = await r.json(); if(j && j.ok && j.result && j.result.price){ base = normalizePriceNumber(j.result.price); } } catch(e){}
  if (base <= 0){ base = 700 + Math.max(0, state.guests-50)*3 + hrs*90; if(state.addons.waffles) base += 180; if(state.addons.frozencap) base += 160; if(state.addons.softice) base += 220; if(state.addons.milkschaum) base += 140; }

  const availDisc = state.availabilityDiscount; let dayDisc = 0; if(days===2) dayDisc = 0.20; if(days>=3) dayDisc = 0.25;
  const afterAvail = base * (1 - availDisc); const afterDays = afterAvail * (1 - dayDisc);
  let travelCost = 0;
  if(state.route && typeof state.route.distanceKm === 'number'){ const billableKm = Math.max(0, state.route.distanceKm - KM_FREE); travelCost = billableKm * KM_RATE; }
  const final = Math.round(afterDays + travelCost);
  state.price = { base, afterAvail, afterDays, final, availDisc, dayDisc, hrs, days };

  out.innerHTML = `
    <div><strong>Preisvorschlag:</strong> ${formatEUR(final)}</div>
    <div class="muted">Basis: ${formatEUR(base)} • Verfügbarkeit: −${Math.round(availDisc*100)}% • Mehrtägig: −${Math.round(dayDisc*100)}% • Dauer: ${hrs} h</div>
  `;
  showStep(6);
});

// ---- Step 6 (Lead) ----
$('back6').addEventListener('click', ()=> showStep(5));
(function(){ const sendBtn=$('sendLead'); const consent=$('consent'); function update(){ sendBtn.disabled=!consent.checked; } consent.addEventListener('change', update); update(); })();
$('sendLead').addEventListener('click', async ()=>{
  const name=$('lead_name').value.trim(), email=$('lead_email').value.trim(), phone=$('lead_phone').value.trim();
  if(!name || !email) return alert('Bitte Name und E‑Mail angeben.');
  const params = new URLSearchParams({
    mode:'lead', name, email, phone,
    date_start: state.date_start, date_end: state.date_end, location: state.location,
    segment: state.segment, priority: (state.priorities||[]).join(', '),
    ref_cat: state.refCategory, ref_sub: state.refSub,
    guests: state.guests, start_time: state.start_time, end_time: state.end_time,
    waffles_on: state.addons.waffles?'1':'0',
    frozencap_on: state.addons.frozencap?'1':'0',
    softice_on: state.addons.softice?'1':'0',
    milkschaum_on: state.addons.milkschaum?'1':'0',
    price_final: state.price? state.price.final : '',
    price_base: state.price? state.price.base : ''
  });
  const box=$('leadMsg'); box.classList.remove('hidden'); box.className='info'; box.textContent='⏳ Sende Anfrage …';
  try{ const r=await fetch(`https://script.google.com/macros/s/AKfycbw4-wgD6hQFoPHGtbew27ysmR8q0NokxGfV_ym2PKgMi5bt415b-PrtG12tKbUXwCpxeg/exec?${params.toString()}`); const j=await r.json(); if(j.ok){ box.className='info ok'; box.innerHTML='✅ Danke! Wir melden uns kurzfristig mit einem Angebot.'; } else { box.className='info warn'; box.innerHTML='⚠️ Konnte nicht gesendet werden: '+(j.error||'Unbekannter Fehler'); } } catch(e){ box.className='info warn'; box.textContent='⚠️ Netzwerkfehler: '+e.message; }
});

// ---- Initialisierung ----
(function init(){
  $('date_start').valueAsDate = new Date();
  $('date_start').min = todayISO(); $('date_end').min = todayISO();
  setActive(1);
  updateSummary();
})();

// ---- Google Places Autocomplete (optional) ----
function initAutocompleteIfAvailable(){
  try{
    if(!(window.google && google.maps && google.maps.places && google.maps.places.Autocomplete)) return;
    const input = document.getElementById('location'); if(!input) return;
    const ac = new google.maps.places.Autocomplete(input, { fields:['formatted_address','geometry'], componentRestrictions:{country:['de']}, types:['geocode'] });
    ac.addListener('place_changed', ()=>{
      const place = ac.getPlace();
      if(place && place.geometry && place.geometry.location){
        state.location = place.formatted_address || input.value.trim();
        state.location_lat = place.geometry.location.lat();
        state.location_lng = place.geometry.location.lng();
      } else { state.location_lat=null; state.location_lng=null; }
    });
  }catch(e){}
}
document.addEventListener('DOMContentLoaded', initAutocompleteIfAvailable);
window.addEventListener('load', initAutocompleteIfAvailable);
</script>

<!-- Google Maps JS (optional, für Distanz & Autocomplete) -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBIRGZPccaGFYnieQTR8gbAox2KDL0pgoQ&libraries=places"></script>
</body>
</html>
