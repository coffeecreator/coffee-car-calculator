<!DOCTYPE html>

<html lang="de">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Coffee‚ÄëCar Wizard ¬∑ v1 Final</title>
<style>
  :root{ --mint:#8BC4B5; --mint-strong:#5DB6A1; --ink:#1A1F2B; --ink-soft:#3B4150; --bg:#FAFBFC; --card:#FFFFFF; --line:#E6E8EB; --muted:#6B7280; --accent:#0F766E; --radius:16px; }
  *{box-sizing:border-box} body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink)}
  .wrap{max-width:1100px; margin:auto; padding:22px}
  .header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
  .brand{display:flex; align-items:center; gap:10px}
  .chip{display:inline-block; padding:6px 10px; border-radius:999px; background:linear-gradient(90deg,#fff,#f4fffb); border:1px solid var(--line); color:var(--accent); font-weight:700}
  h1{margin:0; font-size:clamp(20px,3.5vw,30px)}
  .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:18px; box-shadow:0 4px 18px rgba(0,0,0,.04)}
  .muted{color:var(--muted)}
  .row{display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  label{display:block; font-weight:700; margin:6px 0 6px}
  input,select,button,textarea{width:100%; padding:12px; border-radius:12px; border:1px solid var(--line); background:#fff; color:var(--ink)}
  input:focus,select:focus,textarea:focus{outline:2px solid var(--mint); outline-offset:1px}
  textarea{min-height:96px}
  .btn{cursor:pointer; font-weight:900; background:linear-gradient(90deg,var(--mint),var(--mint-strong)); border:none; color:#083B35}
  .btn-ghost{background:transparent; border:1px solid var(--line); color:var(--ink)}
  .toolbar{display:flex; gap:10px; justify-content:flex-end; margin-top:12px}
  .steps{display:flex; gap:8px; align-items:center; margin:12px 0 16px}
  .dot{width:11px; height:11px; border-radius:50%; background:#d7e7e3; border:1px solid #cfe7df}
  .dot.active{background:var(--mint); border-color:var(--mint-strong)}
  .hidden{display:none !important}
  .info{display:flex; gap:12px; align-items:flex-start; padding:10px; border:1px dashed var(--line); border-radius:12px; background:#F6FAF9; margin-top:8px}
  .ok{color:#0C3F37} .warn{color:#8B5E00}
  .pricebox{display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:999px; background:#F3F7F6; border:1px dashed var(--line); color:var(--accent); margin-top:10px}
  .grid2{display:grid; grid-template-columns:1fr; gap:18px}
  .ref-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px}
  .ref-card{border:1px solid var(--line); border-radius:14px; padding:12px; background:#fff}
  .ref-card h4{margin:0 0 4px 0} .ref-card p{margin:0; color:var(--muted)}
  .ref-actions{display:flex; gap:8px; margin-top:8px}
  .badge{display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; background:#EEF7F5; border:1px solid var(--line); color:#0C3F37}
  body.dark{ background:#0b0f14; color:#e6eef0 }
  body.dark .card{ background:#0f141a; border-color:#1f2a34 }
  body.dark input, body.dark select, body.dark textarea{ background:#0b0f14; color:#e6eef0; border-color:#1f2a34 }
  body.dark .btn-ghost{ color:#d5e2e4; border-color:#1f2a34 }
  body.dark .info{ background:#0f1512; border-color:#1f2a34 }
  body.dark .ref-card{ background:#10161c; border-color:#1f2a34 }
  body.dark .pricebox{ background:#0f1512; border-color:#1f2a34; color:#8BC4B5 }


/* --- Segment selection (Step 2) --- */
.segment-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 14px;
  margin-top: 12px;
}
.segment-card {
  border: 2px solid var(--line);
  border-radius: var(--radius);
  padding: 16px 14px;
  text-align: center;
  cursor: pointer;
  transition: all .2s ease;
  background: #fff;
}
.segment-card:hover {
  border-color: var(--mint);
  background: #f4fffb;
}
.segment-card.active {
  border-color: var(--mint-strong);
  box-shadow: 0 0 0 3px rgba(139,196,181,0.25);
  background: linear-gradient(180deg, #ffffff, #f6fffb);
}
.segment-card h4 {
  margin: 0;
  font-size: 1.05rem;
  color: var(--ink);
}
.segment-card p {
  margin: 4px 0 0;
  font-size: .85rem;
  color: var(--muted);
}
body.dark .segment-card {
  background: #10161c;
  border-color: #1f2a34;
  color: #e6eef0;
}
body.dark .segment-card.active {
  background: #0f1d18;
  border-color: var(--mint-strong);
  box-shadow: 0 0 0 3px rgba(91,182,160,0.25);
}



/* --- Priority multi-select cards (Step 3) --- */
.choice-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 14px;
  margin-top: 12px;
}
.choice-card {
  border: 2px solid var(--line);
  border-radius: var(--radius);
  padding: 14px 14px;
  cursor: pointer;
  transition: all .2s ease;
  background: #fff;
  min-height: 70px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  user-select: none;
}
.choice-card:hover { border-color: var(--mint); background: #f4fffb; }
.choice-card.active {
  border-color: var(--mint-strong);
  box-shadow: 0 0 0 3px rgba(139,196,181,0.25);
  background: linear-gradient(180deg, #ffffff, #f6fffb);
}
body.dark .choice-card {
  background: #10161c;
  border-color: #1f2a34;
  color: #e6eef0;
}
body.dark .choice-card.active {
  background: #0f1d18;
  border-color: var(--mint-strong);
  box-shadow: 0 0 0 3px rgba(91,182,160,0.25);
}



/* --- Step 5: nicer layout & addon cards --- */
.form-grid-2 {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 14px;
}
.addons-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 12px;
  margin-top: 8px;
}
.addon-card {
  border: 2px solid var(--line);
  border-radius: var(--radius);
  padding: 12px 14px;
  background: #fff;
  display: grid;
  grid-template-columns: 1fr auto;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  transition: all .2s ease;
}
.addon-card:hover { border-color: var(--mint); background: #f4fffb; }
.addon-card.active {
  border-color: var(--mint-strong);
  background: linear-gradient(180deg, #ffffff, #f6fffb);
  box-shadow: 0 0 0 3px rgba(139,196,181,0.2);
}
.addon-card h4 { margin: 0; font-size: 1rem; }
.addon-card p { margin: 2px 0 0; font-size: .85rem; color: var(--muted); }
.switch {
  position: relative; width: 44px; height: 24px;
  background: #d7e7e3; border-radius: 999px; transition: background .2s ease;
}
.switch::after {
  content: ''; position: absolute; top: 3px; left: 3px;
  width: 18px; height: 18px; border-radius: 50%; background: #fff;
  box-shadow: 0 1px 3px rgba(0,0,0,.2); transition: left .2s ease;
}
.switch.on { background: var(--mint-strong); }
.switch.on::after { left: 23px; }
body.dark .addon-card { background:#10161c; border-color:#1f2a34; color:#e6eef0; }
body.dark .addon-card.active { background:#0f1d18; border-color:var(--mint-strong); box-shadow: 0 0 0 3px rgba(91,182,160,0.25); }
body.dark .switch { background:#20323a; }


/* --- Per-day time grid (multi-day support) --- */
.daytimes-card { border:1px solid var(--line); border-radius: var(--radius); padding: 12px; background: #fff; margin: 10px 0; }
.daytimes-grid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.daytimes-grid .cell { display:flex; flex-direction:column; }
.daytimes-grid label { font-weight:600; margin:0 0 6px 0; }
body.dark .daytimes-card { background:#10161c; border-color:#1f2a34; }

/* Light-only: neutralize dark mode */
body.dark{
  --bg:#FAFBFC;
  --card:#FFFFFF;
  --line:#E6E8EB;
  --ink:#1A1F2B;
  --ink-soft:#3B4150;
  --accent:#0F766E;
}

</style>
</head>
<body>
<div class="wrap">
<div id="summary" class="hidden"></div>
<div class="header">
<div class="brand"><h1>Coffee‚ÄëCar Buchungs‚ÄëWizard</h1></div>
<div class="steps">
<div class="dot" id="s1"></div><div class="dot" id="s2"></div><div class="dot" id="s3"></div>
<div class="dot" id="s4"></div><div class="dot" id="s5"></div><div class="dot" id="s6"></div>
</div>
</div>
<div class="grid2">
<div class="card">
<div id="step1">
<h2>1) Wann &amp; Wo findet das Event statt?</h2>
<div class="row">
<div><label>Datum (Start)</label><input id="date_start" type="date"/></div>
<div><label>Datum (Ende)</label><input id="date_end" placeholder="optional" type="date"/></div>
<div><label>Ort / PLZ</label><input id="location" placeholder="z. B. 60313 Frankfurt"/></div>
</div>
<div class="toolbar">
<button class="btn" id="checkAvail">Verf√ºgbarkeit pr√ºfen</button>
</div>
<div class="info hidden" id="availInfo"></div>
</div>
<div class="hidden" id="step2">
<h2>2) Wer fragt an?</h2>
<div class="segment-grid" id="segmentGrid"><div class="segment-card" data-value="Privat"><h4>Privat</h4><p>Hochzeiten, Geburtstage, Familienfeiern</p></div><div class="segment-card" data-value="Gewerblich"><h4>Gewerblich</h4><p>Firmenfeiern, Messen, Er√∂ffnungen</p></div><div class="segment-card" data-value="Agenturen / Wiederverk√§ufer"><h4>Agenturen / Wiederverk√§ufer</h4><p>Partner, White‚ÄëLabel, Promotion-Eins√§tze</p></div><div class="segment-card" data-value="Beh√∂rden / √ñffentliche Einrichtungen"><h4>Beh√∂rden / √ñffentliche Einrichtungen</h4><p>Schulen, √Ñmter, Stadtverwaltungen, √∂ffentliche Veranstaltungen</p></div></div>
<div class="toolbar">
<button class="btn-ghost" id="back2">Zur√ºck</button>
<button class="btn" id="next2">Weiter</button>
</div>
</div>
<div class="hidden" id="step3">
<h2>3) Was ist Ihnen besonders wichtig?</h2>
<div class="choice-grid" id="priorityGrid"><div class="choice-card" data-value="Preis &amp; Wirtschaftlichkeit">Preis &amp; Wirtschaftlichkeit</div><div class="choice-card" data-value="Einfach &amp; Zuverl√§ssig">Einfach &amp; Zuverl√§ssig</div><div class="choice-card" data-value="Qualit√§t &amp; Auftritt">Qualit√§t &amp; Auftritt</div><div class="choice-card" data-value="Luxus &amp; Individualisierung">Luxus &amp; Individualisierung</div><div class="choice-card" data-value="Nachhaltigkeit">Nachhaltigkeit</div><div class="choice-card" data-value="Faire L√∂hne">Faire L√∂hne</div><div class="choice-card" data-value="Gro√üe Auswahl an Milchalternativen">Gro√üe Auswahl an Milchalternativen</div><div class="choice-card" data-value="Barista mit Latte‚ÄëArt‚ÄëSkill">Barista mit Latte‚ÄëArt‚ÄëSkill</div></div>
<div class="toolbar">
<button class="btn-ghost" id="back3">Zur√ºck</button>
<button class="btn" id="next3">Weiter</button>
</div>
</div>
<div class="hidden" id="step4">
<h2>4) Passende Referenzen</h2>
<p class="muted">Aus √ºber 3.000 Coffee‚ÄëEvents zeigen wir Ihnen passende Beispiele.</p>
<div class="row">
<div>
<label>Kategorie</label>
<select id="refCategory"></select>
</div>
<div>
<label>Unterkategorie</label>
<select id="refSub"></select>
</div>
</div>
<div class="ref-grid" id="refGrid" style="margin-top:12px"></div>
<div class="toolbar">
<button class="btn-ghost" id="back4">Zur√ºck</button>
<button class="btn" id="next4">Weiter</button>
</div>
</div>
<div class="hidden" id="step5">
<h2>5) Preis &amp; Optionen</h2><div class="daytimes-card" id="dayTimesCard" style="display:none"><div class="daytimes-grid" id="dayTimesGrid"></div></div>
<div class="form-grid-2">
<div><label>G√§stezahl</label><input id="guests" min="1" type="number" value="80"/></div>
<div><label>Ausschankbeginn</label><input id="start_time" type="time" value="09:00"/></div>
<div><label>Ausschankende</label><input id="end_time" type="time" value="13:00"/></div>
<div>
<label>Becher / Tassen</label>
<select id="cupType">
<option>Einwegbecher (kompostierbar)</option>
<option>Porzellantassen</option>
<option>Kunde stellt Tassen</option>
<option>Branding‚ÄëBecher</option>
</select>
</div>
</div>
<div class="addons-grid" id="addonsGrid"><div class="addon-card" data-toggle="waffles_on"><div><h4>Waffeln</h4><p>Frische Waffeln am Stiel (~80 Stk/h)</p></div><div class="switch" id="waffles_on_switch"></div><input id="waffles_on" style="display:none" type="checkbox"/></div><div class="addon-card" data-toggle="frozencap_on"><div><h4>Frozen Cappuccino</h4><p>Cremig-gek√ºhlt ‚Äì Sommer-Favorit</p></div><div class="switch" id="frozencap_on_switch"></div><input id="frozencap_on" style="display:none" type="checkbox"/></div><div class="addon-card" data-toggle="softice_on"><div><h4>Softeis</h4><p>Vanille/Schoko ‚Äì perfekt f√ºr Affogato</p></div><div class="switch" id="softice_on_switch"></div><input id="softice_on" style="display:none" type="checkbox"/></div><div class="addon-card" data-toggle="milkschaum_on"><div><h4>Milchschaumdrucker</h4><p>Logo/Foto/Schrift direkt auf Milchschaum</p></div><div class="switch" id="milkschaum_on_switch"></div><input id="milkschaum_on" style="display:none" type="checkbox"/></div></div><div class="toolbar">
<button class="btn-ghost" id="back5">Zur√ºck</button>
<button class="btn" id="calc">Preis berechnen</button>
</div>
<div class="pricebox hidden" id="priceOut"></div>
</div>
<div class="hidden" id="step6">
<h2>6) Angebot sichern</h2>
<p class="muted">Wir senden Ihnen das Angebot per E‚ÄëMail zu und reservieren den Termin vorl√§ufig.</p>
<div class="row">
<div><label>Name</label><input id="lead_name" placeholder="Max Mustermann"/></div>
<div><label>E‚ÄëMail</label><input id="lead_email" placeholder="max@firma.de" type="email"/></div>
<div><label>Telefon</label><input id="lead_phone" placeholder="+49 ..."/></div>
</div>
<div class="row">
<label><input id="consent" type="checkbox"/> Ich stimme der Verarbeitung meiner Angaben zum Zweck der Angebotserstellung zu.</label>
</div>
<div class="toolbar">
<button class="btn-ghost" id="back6">Zur√ºck</button>
<button class="btn" id="sendLead">Angebot sichern</button>
</div>
<div class="info hidden" id="leadMsg"></div>
</div>
</div>

</div>
<div style="margin-top:16px">
<h3>Hinweis</h3>
<p class="muted">Wochentags‚ÄëZuschl√§ge sind in der Kalkulation bereits ber√ºcksichtigt. Zus√§tzlich gelten tagesabh√§ngige Rabatte und Mehrtages‚ÄëVorteile.</p>
</div>
</div>
</div>
</div>
<script>
const API = "https://script.google.com/macros/s/AKfycbw4-wgD6hQFoPHGtbew27ysmR8q0NokxGfV_ym2PKgMi5bt415b-PrtG12tKbUXwCpxeg/exec";

// Placeholder map; connect to Excel/Sheet via build step later
const REF_MAP = {
  "Privat": {"Hochzeit": {"link":"#", "desc":"Romantische Hochzeiten"}, "Geburtstag": {"link":"#", "desc":"Private Geburtstagsfeiern"}},
  "Gewerblich": {"Messe Autohaus": {"link":"#", "desc":"Autohaus-Promotion"}, "Er√∂ffnung": {"link":"#", "desc":"Gesch√§ftser√∂ffnungen"}},
  "Agenturen / Wiederverk√§ufer": {"Promotion / Subbrand": {"link":"#", "desc":"White-Label- & Partner-Eins√§tze"}},
  "Allgemein": {"Coffee-Car Flotte": {"link":"#", "desc":"√úbersicht Fahrzeuge"}}
};

const state = {
  date_start: "", date_end: "", location: "",
  available: false, availabilityDiscount: 0,
  segment: "", priority: "",
  refCategory: "", refSub: "",
  guests: 80, start_time: "09:00", end_time: "13:00",
  addons: { waffles:false, frozencap:false, softice:false, milkschaum:false },
  price: null
};

function $(id){ return document.getElementById(id); }
function setActive(step){ [1,2,3,4,5,6].forEach(n => $('s'+n).classList.toggle('active', n <= step)); }
function showStep(n){ ['step1','step2','step3','step4','step5','step6'].forEach((id,i)=>{ $(id).classList.toggle('hidden', (i+1)!==n); }); setActive(n); updateSummary(); }
function daysBetween(start,end){ const s=new Date(start); const e=end?new Date(end):new Date(start); if(isNaN(s)) return 0; if(isNaN(e)) return 1; const ms=(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())-Date.UTC(s.getFullYear(),s.getMonth(),s.getDate())); return Math.floor(ms/86400000)+1; }
function formatEUR(v){ return new Intl.NumberFormat('de-DE',{ style:'currency', currency:'EUR'}).format(v); }
function simulateAvailability(){ const r=Math.random(); if(r<0.20) return 0.15; else if(r<0.65) return 0.10; return 0.00; }
function updateSummary(){

  const d1=state.date_start||'‚Äì', d2=state.date_end||state.date_start||'‚Äì';
  const days=daysBetween(state.date_start,state.date_end);
  const seg=state.segment||'‚Äì', pr=state.priority||'‚Äì';
  const disc=state.availabilityDiscount>0? Math.round(state.availabilityDiscount*100)+'% Fr√ºhbucher-Rabatt':'kein Rabatt';
  const html=`
    <div class="badge">Termin: <strong>${d1
try { var el = document.getElementById("summary"); if(el){ el.innerHTML = el.innerHTML; } } catch(e){}
}</strong> bis <strong>${d2}</strong> (${days} Tag/e)</div>
    <div style="margin-top:6px" class="badge">Ort: <strong>${state.location||'‚Äì'}</strong></div>
    <div style="margin-top:6px" class="badge">Segment: <strong>${seg}</strong></div>
    <div style="margin-top:6px" class="badge">Wichtig: <strong>${pr}</strong></div>
    <div style="margin-top:6px" class="badge">Verf√ºgbarkeit: <strong>${state.available? 'verf√ºgbar' : 'unbekannt'}</strong> / Rabatt: <strong>${disc}</strong></div>
  `;
  if($('summary')) $('summary').innerHTML=html;
  document.body.classList.toggle('dark', ['Gewerblich','Agenturen / Wiederverk√§ufer'].includes(state.segment));
}

// Step 1
$('checkAvail').addEventListener('click', ()=>{
  state.date_start = $('date_start').value;
  state.date_end = $('date_end').value;
  state.location = $('location').value.trim();
  if(!state.date_start || !state.location) {
    $('availInfo').className='info warn'; $('availInfo').textContent='Bitte Datum und Ort/PLZ angeben.'; $('availInfo').classList.remove('hidden'); return;
  }
  $('availInfo').className='info'; $('availInfo').innerHTML='‚è≥ Wir pr√ºfen die Verf√ºgbarkeit ‚Ä¶ bitte einen Moment.'; $('availInfo').classList.remove('hidden');
  try { if (window.CCTrack && typeof CCTrack.event==='function') { CCTrack.event('availability_check', { date_start: state.date_start, date_end: state.date_end, location: state.location, segment: state.segment||'' }); } } catch(e) { console.warn('[CCTrack] availability_check error:', e); }

  setTimeout(()=>{
    const disc = simulateAvailability();
    state.available = true;
    state.availabilityDiscount = disc;
    $('availInfo').className='info ok';
    $('availInfo').innerHTML = disc>0 ? 
      `‚úÖ Gute Nachrichten: Wir haben Kapazit√§ten! Sie sparen <strong>${Math.round(disc*100)}%</strong> bei Buchung innerhalb der n√§chsten 48h.`
      : `‚úÖ Termin verf√ºgbar. F√ºr diesen Tag sind aktuell <strong>keine zus√§tzlichen Rabatte</strong> vorgesehen.`;
    updateSummary();
    showStep(2);
  }, 900);
});

// Step 2
$('back2').addEventListener('click', ()=> showStep(1));
$('next2').addEventListener('click', ()=>{
  const val = [...document.querySelectorAll('input[name="segment"]')].find(r=>r.checked)?.value;
  if(!val) return alert('Bitte Segment w√§hlen.');
  state.segment = val;
  updateSummary();
  const cats = Object.keys(REF_MAP);
  const selCat = $('refCategory');
  selCat.innerHTML = '';
  cats.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; selCat.appendChild(o); });
  if(cats.includes(val)) selCat.value = val;
  fillSubcategories();
  showStep(3);
});

// Step 3
function fillSubcategories(){
  const cat = $('refCategory').value;
  const subs = Object.keys(REF_MAP[cat]||{});
  const sel = $('refSub'); sel.innerHTML = '';
  subs.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });
  renderRefs();
}
$('back3').addEventListener('click', ()=> showStep(2));
$('next3').addEventListener('click', ()=>{
  const val = [...document.querySelectorAll('input[name="priority"]')].find(r=>r.checked)?.value;
  if(!val) return alert('Bitte w√§hlen Sie, was Ihnen wichtig ist.');
  state.priority = val;
  updateSummary();
  showStep(4);
});

// Step 4
$('refCategory').addEventListener('change', fillSubcategories);
$('refSub').addEventListener('change', renderRefs);
function renderRefs(){
  const cat = $('refCategory').value;
  const sub = $('refSub').value;
  state.refCategory = cat; state.refSub = sub;
  const grid = $('refGrid'); grid.innerHTML='';
  if(!cat || !sub || !REF_MAP[cat] || !REF_MAP[cat][sub]) return;
  const item = REF_MAP[cat][sub];
  const link = item.link || '#';
  const desc = item.desc || '';
  const card = document.createElement('div'); card.className='ref-card';
  card.innerHTML = `<h4>${cat} ‚Üí ${sub}</h4><p>${desc}</p>
    <div class="ref-actions">
      <a class="btn-ghost" href="${link}" target="_blank" rel="noopener">Ordner √∂ffnen</a>
    </div>`;
  grid.appendChild(card);
}
$('back4').addEventListener('click', ()=> showStep(3));
$('next4').addEventListener('click', ()=> showStep(5));

// Step 5
$('back5').addEventListener('click', ()=> showStep(4));

function customerTypeForSegment(seg){
  if (seg === 'Privat') return 'Privat';
  return 'Gewerblich';
}

$('calc').addEventListener('click', async ()=>{
  state.guests = parseInt($('guests').value||'0',10);
  const st = $('start_time').value, et=$('end_time').value;
  state.start_time = st; state.end_time = et;
  state.addons.waffles = $('waffles_on').checked;
  state.addons.frozencap = $('frozencap_on').checked;
  state.addons.softice = $('softice_on').checked;
  state.addons.milkschaum = $('milkschaum_on').checked;

  const hrs = (()=>{ 
    const [h1,m1]=st.split(':').map(Number); const [h2,m2]=et.split(':').map(Number);
    if(isNaN(h1)||isNaN(h2)) return 4;
    return Math.max(1, (h2*60+m2 - (h1*60+m1))/60);
  })();
  const days = daysBetween(state.date_start, state.date_end);

  const params = new URLSearchParams({
    date_start: state.date_start,
    date_end: state.date_end,
    start_time: state.start_time,
    end_time: state.end_time,
    guests: String(state.guests),
    customer_type: customerTypeForSegment(state.segment),
    event_type: state.priority || 'Sonstige',
    cupType: $('cupType').value,
    waffles_on: state.addons.waffles?'1':'0',
    frozencap_on: state.addons.frozencap?'1':'0',
    softice_on: state.addons.softice?'1':'0',
    milkschaum_on: state.addons.milkschaum?'1':'0'
  });

  const out = $('priceOut'); out.classList.remove('hidden'); out.textContent = '‚è≥ Preis wird berechnet ‚Ä¶';
  let base = 0;
  try {
    const r = await fetch(`${API}?${params.toString()}`);
    const j = await r.json();
    if(j && j.ok && j.result && j.result.price){
      base = normalizePriceNumber(j.result.price);
    }
  } catch(e) { /* fallback below */ }

  if (base <= 0){
    base = 700 + Math.max(0, state.guests-50)*3 + hrs*90;
    if(state.addons.waffles) base += 180;
    if(state.addons.frozencap) base += 160;
    if(state.addons.softice) base += 220;
    if(state.addons.milkschaum) base += 140;
  }

  const availDisc = state.availabilityDiscount; // 0, .10, .15
  let dayDisc = 0;
  if(days===2) dayDisc = 0.20;
  if(days>=3) dayDisc = 0.25;

  const afterAvail = base * (1 - availDisc);
  const afterDays = afterAvail * (1 - dayDisc);
  const final = Math.round(afterDays);

  state.price = { base, afterAvail, afterDays, final, availDisc, dayDisc, hrs, days };

  out.innerHTML = `
    <div><strong>Preisvorschlag:</strong> ${formatEUR(final)}</div>
    <div class="muted">
      Basis: ${formatEUR(base)} ‚Ä¢ Verf√ºgbarkeit: ‚àí${Math.round(availDisc*100)}% ‚Ä¢ Mehrt√§gig: ‚àí${Math.round(dayDisc*100)}% ‚Ä¢ Dauer: ${hrs} h
    </div>
  `;
  showStep(6);
});

// Step 6
$('back6').addEventListener('click', ()=> showStep(5));
(function(){
  const sendBtn = $('sendLead');
  const consent = $('consent');
  function update(){ sendBtn.disabled = !consent.checked; }
  consent.addEventListener('change', update);
  update();
})();

$('sendLead').addEventListener('click', async ()=>{
  const name=$('lead_name').value.trim(), email=$('lead_email').value.trim(), phone=$('lead_phone').value.trim();
  if(!name || !email) return alert('Bitte Name und E‚ÄëMail angeben.');
  const params = new URLSearchParams({
    mode:'lead',
    name, email, phone,
    date_start: state.date_start, date_end: state.date_end, location: state.location,
    segment: state.segment, priority: state.priority,
    ref_cat: state.refCategory, ref_sub: state.refSub,
    guests: state.guests, start_time: state.start_time, end_time: state.end_time,
    waffles_on: state.addons.waffles?'1':'0',
    frozencap_on: state.addons.frozencap?'1':'0',
    softice_on: state.addons.softice?'1':'0',
    milkschaum_on: state.addons.milkschaum?'1':'0',
    price_final: state.price? state.price.final : '',
    price_base: state.price? state.price.base : ''
  });
  const box=$('leadMsg'); box.classList.remove('hidden'); box.className='info'; box.textContent='‚è≥ Sende Anfrage ‚Ä¶';
  try{
    const r = await fetch(`${API}?${params.toString()}`);
    const j = await r.json();
    if(j.ok){
      box.className='info ok'; box.innerHTML='‚úÖ Danke! Wir melden uns kurzfristig mit einem Angebot.';
    } else {
      box.className='info warn'; box.innerHTML='‚ö†Ô∏è Konnte nicht gesendet werden: '+(j.error||'Unbekannter Fehler');
    }
  }catch(e){
    box.className='info warn'; box.textContent='‚ö†Ô∏è Netzwerkfehler: '+e.message;
  }
});

(function init(){
  $('date_start').valueAsDate = new Date();
  setActive(1);
})();


// ===== Sync start & end date =====
(function() {
  const start = document.getElementById('date_start');
  const end = document.getElementById('date_end');

  function syncEnd() {
    if (!start || !end) return;
    if (!start.value) return;
    // Wenn Enddatum leer oder kleiner als Start ‚Üí anpassen
    if (!end.value || end.value < start.value) {
      end.value = start.value;
    }
    end.min = start.value; // Kein Datum vor dem Start erlaubt
  }

  if (start) start.addEventListener('change', syncEnd);
  if (end) end.addEventListener('change', () => {
    if (end.value && start.value && end.value < start.value) {
      alert('Das Enddatum darf nicht vor dem Startdatum liegen.');
      end.value = start.value;
    }
  });

  // Beim Laden direkt setzen
  document.addEventListener('DOMContentLoaded', syncEnd);
})();



// ===== Robust sync for start/end date (v2) =====
(function() {
  const start = document.getElementById('date_start');
  const end = document.getElementById('date_end');
  if (!start || !end) return;

  function ensureDefaults() {
    // Set start = today if empty
    if (!start.value) {
      const today = new Date();
      start.valueAsDate = today;
    }
    // Align end to start if empty or earlier
    if (!end.value || end.value < start.value) {
      end.value = start.value;
    }
    end.min = start.value;
  }

  function onStartChange() {
    if (!start.value) return;
    if (!end.value || end.value < start.value) {
      end.value = start.value;
    }
    end.min = start.value;
  }

  function onEndChange() {
    if (end.value && start.value && end.value < start.value) {
      end.value = start.value;
    }
  }

  // Init now
  ensureDefaults();

  // Also run after the rest of init
  document.addEventListener('DOMContentLoaded', ensureDefaults);

  start.addEventListener('input', onStartChange);
  start.addEventListener('change', onStartChange);
  end.addEventListener('input', onEndChange);
  end.addEventListener('change', onEndChange);
})();



// --- Fancy segment cards ---
(function(){
  const grid = document.getElementById('segmentGrid');
  if(!grid) return;
  const cards = grid.querySelectorAll('.segment-card');
  cards.forEach(card=>{
    card.addEventListener('click', ()=>{
      cards.forEach(c=>c.classList.remove('active'));
      card.classList.add('active');
      state.segment = card.dataset.value;
      updateSummary();
    });
  });

  // Override "Weiter" handler for Step 2 to use state.segment
  (function(){
    const oldBtn = document.getElementById('next2');
    const btn = oldBtn.cloneNode(true);
    oldBtn.replaceWith(btn);
    btn.addEventListener('click', ()=>{
      if(!state.segment){
        alert('Bitte Segment w√§hlen.');
        return;
      }
      // Prefill references based on segment
      const cats = Object.keys(REF_MAP);
      const selCat = document.getElementById('refCategory');
      selCat.innerHTML = '';
      cats.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; selCat.appendChild(o); });
      if(cats.includes(state.segment)) selCat.value = state.segment;
      // Fill subs & go next
      if (typeof fillSubcategories === 'function') fillSubcategories();
      showStep(3);
    });
  })();
})();



// --- Multi-select priority cards (Step 3) ---
(function(){
  // ensure state.priorities exists
  if (!Array.isArray(state.priorities)) state.priorities = [];
  const grid = document.getElementById('priorityGrid');
  if(grid){
    const cards = grid.querySelectorAll('.choice-card');
    cards.forEach(card=>{
      card.addEventListener('click', ()=>{
        const val = card.dataset.value;
        const idx = state.priorities.indexOf(val);
        if(idx >= 0){
          // remove
          state.priorities.splice(idx,1);
          card.classList.remove('active');
        }else{
          // add
          state.priorities.push(val);
          card.classList.add('active');
        }
        updateSummary();
      });
    });
  }

  // Override "Weiter" (step3) to require at least one selection
  (function(){
    const oldBtn = document.getElementById('next3');
    const btn = oldBtn.cloneNode(true);
    oldBtn.replaceWith(btn);
    btn.addEventListener('click', ()=>{
      if(!state.priorities || state.priorities.length === 0){
        alert('Bitte w√§hlen Sie mindestens eine Priorit√§t.');
        return;
      }
      showStep(4);
    });
  })();
})();

// --- Patch summary to show priorities list
(function(){
  const oldUpdate = updateSummary;
  updateSummary = function(){
    oldUpdate();
    // replace "Wichtig" badge to show joined list
    const pr = (state.priorities && state.priorities.length) ? state.priorities.join(', ') : (state.priority || '‚Äì');
    const summary = document.getElementById('summary'); /* safe */
    if(summary){
      // rebuild with the existing HTML but swap the "Wichtig" line
      const d1 = state.date_start || '‚Äì';
      const d2 = state.date_end || state.date_start || '‚Äì';
      const days = (function(s,e){ const sd=new Date(s); const ed=e?new Date(e):new Date(s); if(isNaN(sd)) return 0; if(isNaN(ed)) return 1; const ms=(Date.UTC(ed.getFullYear(),ed.getMonth(),ed.getDate())-Date.UTC(sd.getFullYear(),sd.getMonth(),sd.getDate())); return Math.floor(ms/86400000)+1; })(state.date_start,state.date_end);
      const seg = state.segment || '‚Äì';
      const disc = state.availabilityDiscount>0? Math.round(state.availabilityDiscount*100)+'% Fr√ºhbucher-Rabatt':'kein Rabatt';
      summary.innerHTML = `
        <div class="badge">Termin: <strong>${d1}</strong> bis <strong>${d2}</strong> (${days} Tag/e)</div>
        <div style="margin-top:6px" class="badge">Ort: <strong>${state.location||'‚Äì'}</strong></div>
        <div style="margin-top:6px" class="badge">Segment: <strong>${seg}</strong></div>
        <div style="margin-top:6px" class="badge">Wichtig: <strong>${pr}</strong></div>
        <div style="margin-top:6px" class="badge">Verf√ºgbarkeit: <strong>${state.available? 'verf√ºgbar' : 'unbekannt'}</strong> / Rabatt: <strong>${disc}</strong></div>
      `;
    }
  };
})();

// --- Patch calc & lead to pass priorities (first for event_type, joined for metadata)
(function(){
  // override calc button handler
  const oldCalc = document.getElementById('calc');
  if(oldCalc){
    const btn = oldCalc.cloneNode(true);
    oldCalc.replaceWith(btn);
    btn.addEventListener('click', async ()=>{
      state.guests = parseInt(document.getElementById('guests').value||'0',10);
      const st = document.getElementById('start_time').value, et=document.getElementById('end_time').value;
      state.start_time = st; state.end_time = et;
      state.addons.waffles = document.getElementById('waffles_on').checked;
      state.addons.frozencap = document.getElementById('frozencap_on').checked;
      state.addons.softice = document.getElementById('softice_on').checked;
      state.addons.milkschaum = document.getElementById('milkschaum_on').checked;

      const hrs = (function(){ const [h1,m1]=st.split(':').map(Number); const [h2,m2]=et.split(':').map(Number); if(isNaN(h1)||isNaN(h2)) return 4; return Math.max(1, (h2*60+m2 - (h1*60+m1))/60); })();
      const days = (function(start,end){ const s=new Date(start); const e=end?new Date(end):new Date(start); if(isNaN(s)) return 0; if(isNaN(e)) return 1; const ms=(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())-Date.UTC(s.getFullYear(),s.getMonth(),s.getDate())); return Math.floor(ms/86400000)+1; })(state.date_start,state.date_end);

      const prioritiesJoined = (state.priorities && state.priorities.length) ? state.priorities.join(', ') : (state.priority || '');
      const eventTypeForAPI = (state.priorities && state.priorities.length) ? state.priorities[0] : (state.priority || 'Sonstige');

      const params = new URLSearchParams({
        date_start: state.date_start,
        date_end: state.date_end,
        start_time: state.start_time,
        end_time: state.end_time,
        guests: String(state.guests),
        customer_type: (state.segment==='Privat')?'Privat':'Gewerblich',
        event_type: eventTypeForAPI,
        cupType: document.getElementById('cupType').value,
        waffles_on: state.addons.waffles?'1':'0',
        frozencap_on: state.addons.frozencap?'1':'0',
        softice_on: state.addons.softice?'1':'0',
        milkschaum_on: state.addons.milkschaum?'1':'0'
      });

      const out = document.getElementById('priceOut'); out.classList.remove('hidden'); out.textContent = '‚è≥ Preis wird berechnet ‚Ä¶';
      let base = 0;
      try {
        const r = await fetch(`${API}?${params.toString()}`);
        const j = await r.json();
        if(j && j.ok && j.result && j.result.price){
          const num = String(j.result.price).replace(/[^0-9,.-]/g,'').replace(/\./g,'').replace(',', '.');
          base = parseFloat(num);
          if (isNaN(base)) base = 0;
        }
      } catch(e) { /* fallback below */ }

      if (base <= 0){
        base = 700 + Math.max(0, state.guests-50)*3 + hrs*90;
        if(state.addons.waffles) base += 180;
        if(state.addons.frozencap) base += 160;
        if(state.addons.softice) base += 220;
        if(state.addons.milkschaum) base += 140;
      }

      const availDisc = state.availabilityDiscount; 
      let dayDisc = 0; if(days===2) dayDisc = 0.20; if(days>=3) dayDisc = 0.25;
      const afterAvail = base * (1 - availDisc);
      const afterDays = afterAvail * (1 - dayDisc);
      const final = Math.round(afterDays);
      state.price = { base, afterAvail, afterDays, final, availDisc, dayDisc, hrs, days };

      out.innerHTML = `
        <div><strong>Preisvorschlag:</strong> ${new Intl.NumberFormat('de-DE',{ style:'currency', currency:'EUR'}).format(final)}</div>
        <div class="muted">
          Basis: ${new Intl.NumberFormat('de-DE',{ style:'currency', currency:'EUR'}).format(base)} ‚Ä¢ Verf√ºgbarkeit: ‚àí${Math.round(availDisc*100)}% ‚Ä¢ Mehrt√§gig: ‚àí${Math.round(dayDisc*100)}% ‚Ä¢ Dauer: ${hrs} h
        </div>
      `;
      showStep(6);
    });
  }
  // augment lead to include prioritiesJoined
  const sendBtn = document.getElementById('sendLead');
  if(sendBtn){
    const oldHandler = sendBtn.onclick;
    sendBtn.replaceWith((function(orig){
      const btn = orig.cloneNode(true);
      btn.addEventListener('click', async ()=>{
        const name=document.getElementById('lead_name').value.trim(), email=document.getElementById('lead_email').value.trim(), phone=document.getElementById('lead_phone').value.trim();
        if(!name || !email) return alert('Bitte Name und E‚ÄëMail angeben.');
        const prioritiesJoined = (state.priorities && state.priorities.length) ? state.priorities.join(', ') : (state.priority || '');
        const params = new URLSearchParams({
          mode:'lead', name, email, phone,
          date_start: state.date_start, date_end: state.date_end, location: state.location,
          segment: state.segment, priority: prioritiesJoined,
          ref_cat: state.refCategory, ref_sub: state.refSub,
          guests: state.guests, start_time: state.start_time, end_time: state.end_time,
          waffles_on: state.addons.waffles?'1':'0',
          frozencap_on: state.addons.frozencap?'1':'0',
          softice_on: state.addons.softice?'1':'0',
          milkschaum_on: state.addons.milkschaum?'1':'0',
          price_final: state.price? state.price.final : '',
          price_base: state.price? state.price.base : ''
        });
        const box=document.getElementById('leadMsg'); box.classList.remove('hidden'); box.className='info'; box.textContent='‚è≥ Sende Anfrage ‚Ä¶';
        try{
          const r = await fetch(`${API}?${params.toString()}`);
          const j = await r.json();
          if(j.ok){ box.className='info ok'; box.innerHTML='‚úÖ Danke! Wir melden uns kurzfristig mit einem Angebot.'; }
          else{ box.className='info warn'; box.innerHTML='‚ö†Ô∏è Konnte nicht gesendet werden: '+(j.error||'Unbekannter Fehler'); }
        }catch(e){ box.className='info warn'; box.textContent='‚ö†Ô∏è Netzwerkfehler: '+e.message; }
      });
      return btn;
    })(sendBtn));
  }
})();



// --- Step 5 addon card toggles ---
(function(){
  const grid = document.getElementById('addonsGrid');
  if(!grid) return;
  grid.querySelectorAll('.addon-card').forEach(card=>{
    const id = card.dataset.toggle;
    const hidden = document.getElementById(id);
    const sw = document.getElementById(id + '_switch');
    function sync(){
      if(hidden.checked){
        card.classList.add('active'); sw.classList.add('on');
      }else{
        card.classList.remove('active'); sw.classList.remove('on');
      }
    }
    card.addEventListener('click', ()=>{
      hidden.checked = !hidden.checked;
      sync();
    });
    sync();
  });
})();



// --- Normalize price number from API (handles 2.080,00 ‚Ç¨, 208.000,00 ‚Ç¨, etc.) ---
function normalizePriceNumber(raw){
  if(raw == null) return 0;
  let s = String(raw).trim();
  const original = s;
  s = s.replace(/[^0-9,.-]/g,'').trim();
  if (/\d{1,3}(\.\d{3})+,\d{2}$/.test(s)) {
    s = s.replace(/\./g, '').replace(',', '.');
  } else if (/\d+,\d{2}$/.test(s)) {
    s = s.replace(',', '.');
  } else if (/\d+\.\d{2}$/.test(s)) {
    // ok
  } else {
    const lastComma = s.lastIndexOf(',');
    if (lastComma !== -1) {
      s = s.slice(0,lastComma).replace(/\./g,'') + '.' + s.slice(lastComma+1);
    } else {
      s = s.replace(/\./g,'');
    }
  }
  let num = parseFloat(s);
  if (!isFinite(num) || isNaN(num)) num = 0;
  if (num > 20000) num = num / 100;
  return num;
}


// === Price normalizer (cents-based)
function normalizePriceNumber(raw){
  if(raw == null) return 0;
  const digits = String(raw).replace(/\D/g,'');
  if(digits.length >= 3){
    return parseInt(digits.slice(0,-2),10) + parseInt(digits.slice(-2),10)/100;
  }
  let s = String(raw).replace(/[^0-9,.-]/g,'').trim();
  if (/^\d{1,3}(\.\d{3})+,\d{2}$/.test(s)) s = s.replace(/\./g,'').replace(',', '.');
  else if (/^\d+,\d{2}$/.test(s)) s = s.replace(',', '.');
  else if (/^\d+\.\d{2}$/.test(s)) {/*ok*/}
  else { const last=s.lastIndexOf(','); if(last!==-1) s=s.slice(0,last).replace(/\./g,'')+'.'+s.slice(last+1); else s=s.replace(/\./g,''); }
  let num=parseFloat(s); if(!isFinite(num)||isNaN(num)) num=0; if(num>20000) num=num/100; return num;
}

// === Multi-day time rows
function enumerateDates(startStr, endStr){
  if(!startStr) return [];
  const start=new Date(startStr); const end=endStr?new Date(endStr):new Date(startStr);
  const out=[]; let d=new Date(Date.UTC(start.getFullYear(),start.getMonth(),start.getDate()));
  const endUTC=Date.UTC(end.getFullYear(),end.getMonth(),end.getDate());
  while(d.getTime()<=endUTC){ out.push(new Date(d)); d.setUTCDate(d.getUTCDate()+1) }
  return out;
}
function fmtISO(d){ const y=d.getUTCFullYear(), m=String(d.getUTCMonth()+1).padStart(2,'0'), da=String(d.getUTCDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
function rebuildDayTimes(){
  const grid = document.getElementById('dayTimesGrid');
  const card = document.getElementById('dayTimesCard');
  if(!grid||!card) return;
  const dates = enumerateDates(state.date_start, state.date_end);
  grid.innerHTML='';
  if(dates.length<=1){ card.style.display='none'; return; }
  card.style.display='';
  const st = document.getElementById('start_time').value || '09:00';
  const et = document.getElementById('end_time').value || '13:00';
  dates.forEach(d=>{
    const row = document.createElement('div'); row.className='daytimes-grid';
    row.innerHTML = `
      <div class="cell"><label>Datum</label><input type="date" value="${fmtISO(d)}" data-role="date"></div>
      <div class="cell"><label>Beginn</label><input type="time" value="${st}" data-role="start"></div>
      <div class="cell"><label>Ende</label><input type="time" value="${et}" data-role="end"></div>`;
    grid.appendChild(row);
  });
}
function calcTotalHours(){
  const grid = document.getElementById('dayTimesGrid');
  if(!grid || grid.children.length===0){
    const st = document.getElementById('start_time').value, et = document.getElementById('end_time').value;
    const [h1,m1]=(st||'09:00').split(':').map(Number); const [h2,m2]=(et||'13:00').split(':').map(Number);
    return Math.max(1, ((h2*60+m2)-(h1*60+m1))/60);
  }
  let total=0;
  grid.querySelectorAll('.daytimes-grid').forEach(row=>{
    const st = row.querySelector('[data-role="start"]').value;
    const et = row.querySelector('[data-role="end"]').value;
    const [h1,m1]=(st||'09:00').split(':').map(Number); const [h2,m2]=(et||'13:00').split(':').map(Number);
    total += Math.max(1, ((h2*60+m2)-(h1*60+m1))/60);
  });
  return total;
}

// rebuild rows on date change and when entering step 5
document.getElementById('date_start')?.addEventListener('change', rebuildDayTimes);
document.getElementById('date_end')?.addEventListener('change', rebuildDayTimes);
(function(){
  const next4 = document.getElementById('next4');
  if(next4){
    const btn = next4.cloneNode(true);
    next4.replaceWith(btn);
    btn.addEventListener('click', ()=>{ showStep(5); rebuildDayTimes(); });
  }
})();

// override calc: use total hours + normalized base price
(function(){
  const old = document.getElementById('calc');
  if(!old) return;
  const btn = old.cloneNode(true);
  old.replaceWith(btn);
  btn.addEventListener('click', async ()=>{
    rebuildDayTimes();
    const hrs = calcTotalHours();
    state.guests = parseInt(document.getElementById('guests').value||'0',10);
    state.start_time = document.getElementById('start_time').value;
    state.end_time = document.getElementById('end_time').value;
    state.addons.waffles = document.getElementById('waffles_on').checked;
    state.addons.frozencap = document.getElementById('frozencap_on').checked;
    state.addons.softice = document.getElementById('softice_on').checked;
    state.addons.milkschaum = document.getElementById('milkschaum_on').checked;

    const params = new URLSearchParams({
      date_start: state.date_start,
      date_end: state.date_end,
      start_time: state.start_time,
      end_time: state.end_time,
      guests: String(state.guests),
      customer_type: (state.segment==='Privat')?'Privat':'Gewerblich',
      event_type: (state.priorities && state.priorities[0]) ? state.priorities[0] : (state.priority || 'Sonstige'),
      cupType: document.getElementById('cupType').value,
      waffles_on: state.addons.waffles?'1':'0',
      frozencap_on: state.addons.frozencap?'1':'0',
      softice_on: state.addons.softice?'1':'0',
      milkschaum_on: state.addons.milkschaum?'1':'0'
    });

    const out = document.getElementById('priceOut'); out.classList.remove('hidden'); out.textContent = '‚è≥ Preis wird berechnet ‚Ä¶';
    let base = 0;
    try {
      const r = await fetch(`${API}?${params.toString()}`);
      const j = await r.json();
      if(j && j.ok && j.result && j.result.price){
        base = normalizePriceNumber(j.result.price);
      }
    } catch(e) { /* fallback below */ }

    if (base <= 0){
      base = 700 + Math.max(0, state.guests-50)*3 + hrs*90;
      if(state.addons.waffles) base += 180;
      if(state.addons.frozencap) base += 160;
      if(state.addons.softice) base += 220;
      if(state.addons.milkschaum) base += 140;
    }
    const days = (function(s,e){ const sd=new Date(s); const ed=e?new Date(e):new Date(s); if(isNaN(sd)) return 1; if(isNaN(ed)) return 1; const ms=(Date.UTC(ed.getFullYear(),ed.getMonth(),ed.getDate())-Date.UTC(sd.getFullYear(),sd.getMonth(),sd.getDate())); return Math.floor(ms/86400000)+1; })(state.date_start,state.date_end);
    const availDisc = state.availabilityDiscount;
    let dayDisc = 0; if(days===2) dayDisc = 0.20; if(days>=3) dayDisc = 0.25;
    const afterAvail = base * (1 - availDisc);
    const afterDays = afterAvail * (1 - dayDisc);
    const final = Math.round(afterDays);
    state.price = { base, afterAvail, afterDays, final, availDisc, dayDisc, hrs, days };
    try { if (window.CCTrack && typeof CCTrack.event==='function') { CCTrack.event('price_calculated', { guests: state.guests, hours: hrs, addons: Object.keys(state.addons).filter(k=>state.addons[k]), price: final }); } } catch(e) { console.warn('[CCTrack] price_calculated error:', e); }
    out.innerHTML = `
      <div><strong>Preisvorschlag:</strong> ${new Intl.NumberFormat('de-DE',{ style:'currency', currency:'EUR'}).format(final)}</div>
      <div class="muted">
        Basis: ${new Intl.NumberFormat('de-DE',{ style:'currency', currency:'EUR'}).format(base)} ‚Ä¢ Verf√ºgbarkeit: ‚àí${Math.round(availDisc*100)}% ‚Ä¢ Mehrt√§gig: ‚àí${Math.round(dayDisc*100)}% ‚Ä¢ Dauer: ${hrs} h
      </div>`;
    showStep(6);
  });
})();
</script>

<!-- === COOKIE NOTICE (Coffee-Car CI) === -->
<div id="cc-cookie" style="position:fixed;z-index:9999;bottom:20px;left:50%;transform:translateX(-50%);
background:#fff;border:1px solid #e5e7eb;box-shadow:0 6px 20px rgba(31,41,55,.12);border-radius:16px;
max-width:480px;width:calc(100% - 40px);padding:22px 20px;display:none;animation:fadeIn .6s ease;">
  <div style="display:flex;flex-direction:column;gap:10px;">
    <p style="margin:0;font-size:.95rem;color:#374151;line-height:1.5;">
      üç™ <strong>Wir respektieren Ihre Privatsph√§re.</strong><br>
      Diese Website verwendet nur technisch notwendige Cookies, um den Coffee-Car-Kalkulator und die Kontaktfunktion bereitzustellen.
      Analytik- oder Marketing-Cookies werden <u>nicht</u> gesetzt, sofern Sie dem nicht ausdr√ºcklich zustimmen.
    </p>
    <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end;">
      <button id="cc-cookie-accept" style="background:var(--mint,#8BC4B5);border:none;padding:8px 14px;border-radius:999px;
      font-weight:600;color:#0f5132;cursor:pointer;">Nur notwendige akzeptieren</button>
      <button id="cc-cookie-pref" style="background:#fff;border:1px solid #d1d5db;padding:8px 14px;border-radius:999px;
      font-weight:500;color:#374151;cursor:pointer;">Einstellungen</button>
    </div>
  </div>
</div>

<!-- === COOKIE PREFERENCES MODAL === -->
<div id="cc-pref-modal" style="position:fixed;z-index:10000;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.2);max-width:420px;width:90%;padding:24px;">
    <h3 style="margin-top:0;">Cookie-Einstellungen</h3>
    <p style="font-size:.95rem;line-height:1.6;">W√§hlen Sie, welche Cookies wir setzen d√ºrfen:</p>
    <label style="display:block;margin-bottom:10px;">
      <input type="checkbox" disabled checked> Notwendig ‚Äì f√ºr Funktion & Sicherheit (immer aktiv)
    </label>
    <label style="display:block;margin-bottom:14px;">
      <input type="checkbox" id="cc-analytics"> Analytik ‚Äì anonyme Nutzungsauswertung (z.&nbsp;B. Seitenaufrufe)
    </label>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button id="cc-save" style="background:var(--mint,#8BC4B5);border:none;padding:8px 14px;border-radius:999px;
      font-weight:600;color:#0f5132;cursor:pointer;">Speichern</button>
      <button id="cc-cancel" style="background:#fff;border:1px solid #d1d5db;padding:8px 14px;border-radius:999px;
      font-weight:500;color:#374151;cursor:pointer;">Abbrechen</button>
    </div>
  </div>
</div>

<!-- === ENHANCED COOKIE SCRIPT (mit Consent-Event) === -->
<script>
(function(){
  const box=document.getElementById('cc-cookie');
  const modal=document.getElementById('cc-pref-modal');
  const analyticsBox=document.getElementById('cc-analytics');
  const KEY='cc-cookie-state';

  const state=localStorage.getItem(KEY);
  if(!state){ box.style.display='block'; }

  function setState(val){
    localStorage.setItem(KEY,val);
    window.dispatchEvent(new CustomEvent('cc-consent-changed',{detail:{state:val}}));
  }

  document.getElementById('cc-cookie-accept').onclick=()=>{
    setState('necessary'); box.style.display='none';
  };
  document.getElementById('cc-cookie-pref').onclick=()=>{ modal.style.display='flex'; };

  document.getElementById('cc-save').onclick=()=>{
    const pref=analyticsBox && analyticsBox.checked ? 'analytics' : 'necessary';
    setState(pref); modal.style.display='none'; box.style.display='none';
  };
  document.getElementById('cc-cancel').onclick=()=>{ modal.style.display='none'; };

  if(state==='analytics'){
    window.dispatchEvent(new CustomEvent('cc-consent-changed',{detail:{state}}));
  }
})();
</script>

<!-- === ANALYTICS LOADER (l√§dt nur bei consent = 'analytics') === -->
<script>
(function(){
  const RESPECT_DNT = true;

  // TODO: Trage hier deine IDs/URLs ein
  const GA4_ID      = 'G-XXXXXXXXXX';            // z.B. G-AB12C3D4EF
  const MATOMO_URL  = '';                        // z.B. https://analytics.deine-domain.de
  const MATOMO_SITE = '';                        // z.B. "1"

  let gaLoaded=false, matomoLoaded=false;

  function dntEnabled(){
    return RESPECT_DNT && (
      navigator.doNotTrack === '1' ||
      window.doNotTrack === '1' ||
      navigator.msDoNotTrack === '1'
    );
  }

  function loadScript(src, async=true){
    return new Promise((resolve,reject)=>{
      const s=document.createElement('script');
      s.src=src; s.async=async;
      s.onload=resolve; s.onerror=reject;
      document.head.appendChild(s);
    });
  }

  async function initGA4(){
    if(gaLoaded || !GA4_ID) return;
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    window.gtag = gtag;
    gtag('js', new Date());
    gtag('config', GA4_ID, { anonymize_ip: true });
    await loadScript('https://www.googletagmanager.com/gtag/js?id='+encodeURIComponent(GA4_ID));
    gaLoaded=true;
  }

  async function initMatomo(){
    if(matomoLoaded || !MATOMO_URL || !MATOMO_SITE) return;
    window._paq = window._paq || [];
    _paq.push(['requireConsent']);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    _paq.push(['setDoNotTrack', RESPECT_DNT]);
    (function() {
      const u = MATOMO_URL.replace(/\/+$/,'/') ;
      _paq.push(['setTrackerUrl', u+'matomo.php']);
      _paq.push(['setSiteId', MATOMO_SITE]);
      const d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
    })();
    _paq.push(['rememberConsentGiven']);
    matomoLoaded=true;
  }

  async function enableAnalytics(){
    if(dntEnabled()){
      console.info('[CC] DNT aktiv ‚Äì Analytics werden nicht geladen.');
      return;
    }
    await Promise.all([initGA4(), initMatomo()]);
    console.info('[CC] Analytics aktiviert.');
  }

  window.addEventListener('cc-consent-changed', (e)=>{
    const st = e && e.detail && e.detail.state;
    if(st === 'analytics'){ enableAnalytics(); }
  });

  try{
    const current = localStorage.getItem('cc-cookie-state');
    if(current === 'analytics'){ enableAnalytics(); }
  }catch(err){ /* ignore */ }

  window.CCTrack = {
    event: function(name, params){
      if(window.gtag){ window.gtag('event', name, params||{}); }
      if(window._paq){ window._paq.push(['trackEvent','CC', name, JSON.stringify(params||{})]); }
    },
    pageview: function(url){
      if(window.gtag){ window.gtag('event', 'page_view', {page_location:url||location.href}); }
      if(window._paq){
        if(url){ window._paq.push(['setCustomUrl', url]); }
        window._paq.push(['trackPageView']);
      }
    }
  };
})();
</script>

<style>
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:none;}}
</style>

</body>
</html>
